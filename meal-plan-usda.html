<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="frame-ancestors *;">
    <meta http-equiv="X-Frame-Options" content="ALLOWALL">
    <title>BUILT Automated Meal Plan Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        .container {
            max-width: 1000px;
            margin: auto;
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #1a1a1a;
            color: #f5f5f5;
            border-radius: 10px;
        }

        .section {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #444;
        }

        .section-title {
            color: #4da6d9;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #4da6d9;
            padding-bottom: 5px;
        }

        .macro-inputs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .macro-input {
            text-align: center;
        }

        .macro-input label {
            display: block;
            font-size: 14px;
            color: #4da6d9;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .macro-input input {
            width: 100%;
            padding: 10px;
            background: #1e1e1e;
            color: white;
            border: 1px solid #444;
            border-radius: 4px;
            text-align: center;
            font-size: 16px;
        }

        .food-category {
            margin-bottom: 20px;
        }

        .category-title {
            color: #4da6d9;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .food-search-input {
            width: 100%;
            padding: 10px;
            background: #1e1e1e;
            color: white;
            border: 1px solid #444;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .food-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            background: #1a1a1a;
        }

        .food-item {
            background: #333;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .food-item:hover {
            background: #444;
            border-color: #4da6d9;
        }

        .food-item.selected {
            background: #4da6d9;
            color: white;
            border-color: #4da6d9;
        }

        .food-name {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .food-macros {
            font-size: 10px;
            color: #ccc;
        }

        .selected.food-macros {
            color: white;
        }

        .food-badges {
            display: flex;
            gap: 5px;
            margin-top: 3px;
        }

        .macro-badge {
            padding: 1px 4px;
            border-radius: 2px;
            font-size: 8px;
            font-weight: bold;
        }

        .protein-badge { background: #e74c3c; color: white; }
        .carb-badge { background: #f39c12; color: white; }
        .fat-badge { background: #9b59b6; color: white; }
        .mixed-badge { background: #34495e; color: white; }

        .selected-foods {
            margin-top: 15px;
            padding: 10px;
            background: #1a1a1a;
            border-radius: 4px;
            border: 1px solid #333;
        }

        .selected-foods h4 {
            color: #4da6d9;
            margin: 0 0 10px 0;
            font-size: 14px;
        }

        .selected-food-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .selected-food-tag {
            background: #4da6d9;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
        }

        .selected-food-tag:hover {
            background: #e74c3c;
        }

        .generate-btn {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            background: linear-gradient(45deg, #4da6d9, #2ecc71);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 20px 0;
            transition: transform 0.2s ease;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
        }

        .generate-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .meal-plan-output {
            display: none;
            background: #0f3460;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #4da6d9;
            margin-top: 20px;
        }

        .meal-plan-output.active {
            display: block;
        }

        .meal-section {
            background: #1a4a6b;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .meal-header {
            color: #4da6d9;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            border-bottom: 1px solid #4da6d9;
            padding-bottom: 5px;
        }

        .meal-food {
            background: #2a4a6b;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 3px solid #4da6d9;
        }

        .food-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .food-info {
            flex: 1;
        }

        .food-quantity {
            font-weight: bold;
            color: #2ecc71;
        }

        .food-nutrition {
            font-size: 12px;
            color: #ccc;
            margin-top: 3px;
        }

        .meal-totals {
            background: #0a2240;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 13px;
            border: 1px solid #4da6d9;
        }

        .daily-summary {
            background: #0a2240;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 2px solid #2ecc71;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            text-align: center;
        }

        .summary-item {
            background: #1a4a6b;
            padding: 15px;
            border-radius: 6px;
        }

        .summary-number {
            font-size: 24px;
            font-weight: bold;
            color: #2ecc71;
        }

        .summary-label {
            font-size: 12px;
            color: #ccc;
            margin-top: 5px;
        }

        .progress-bar {
            background: #333;
            height: 8px;
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .protein-fill { background: #e74c3c; }
        .carbs-fill { background: #f39c12; }
        .fat-fill { background: #9b59b6; }
        .calories-fill { background: #2ecc71; }

        .download-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
        }

        .loading {
            text-align: center;
            color: #4da6d9;
            font-style: italic;
        }
    </style>
</head>
<body>
<div class="container">
    <h2 style="text-align: center; color: #4da6d9; margin-bottom: 10px;">BUILT Automated Meal Plan Generator</h2>
    <p style="text-align: center; margin-bottom: 30px; color: #ccc;">Set your preferences and get a complete meal plan with calculated quantities</p>

    <!-- Macro Targets -->
    <div class="section">
        <div class="section-title">üìä Daily Macro Targets</div>
        <div class="macro-inputs">
            <div class="macro-input">
                <label>Protein (g)</label>
                <input type="number" id="targetProtein" value="150" min="50" max="400">
            </div>
            <div class="macro-input">
                <label>Carbs (g)</label>
                <input type="number" id="targetCarbs" value="200" min="50" max="600">
            </div>
            <div class="macro-input">
                <label>Fat (g)</label>
                <input type="number" id="targetFat" value="60" min="20" max="200">
            </div>
            <div class="macro-input">
                <label>Meals</label>
                <input type="number" id="mealsCount" value="4" min="3" max="6">
            </div>
        </div>
    </div>

    <!-- Food Preferences -->
    <div class="section">
        <div class="section-title">üçΩÔ∏è Food Preferences</div>
        
        <!-- Proteins -->
        <div class="food-category">
            <div class="category-title">ü•© Protein Sources</div>
            <input type="text" class="food-search-input" id="proteinSearch" placeholder="Search proteins... (chicken, salmon, eggs)" oninput="searchFoods('protein')">
            <div class="food-grid" id="proteinGrid"></div>
            <div class="selected-foods">
                <h4>Selected Proteins:</h4>
                <div class="selected-food-tags" id="selectedProteins"></div>
            </div>
        </div>

        <!-- Carbs -->
        <div class="food-category">
            <div class="category-title">üçö Carbohydrate Sources</div>
            <input type="text" class="food-search-input" id="carbSearch" placeholder="Search carbs... (rice, oats, pasta)" oninput="searchFoods('carb')">
            <div class="food-grid" id="carbGrid"></div>
            <div class="selected-foods">
                <h4>Selected Carbs:</h4>
                <div class="selected-food-tags" id="selectedCarbs"></div>
            </div>
        </div>

        <!-- Fats -->
        <div class="food-category">
            <div class="category-title">ü•ë Fat Sources</div>
            <input type="text" class="food-search-input" id="fatSearch" placeholder="Search fats... (avocado, nuts, oil)" oninput="searchFoods('fat')">
            <div class="food-grid" id="fatGrid"></div>
            <div class="selected-foods">
                <h4>Selected Fats:</h4>
                <div class="selected-food-tags" id="selectedFats"></div>
            </div>
        </div>

        <!-- Fruits & Vegetables -->
        <div class="food-category">
            <div class="category-title">ü•¨ Fruits & Vegetables</div>
            <input type="text" class="food-search-input" id="veggieSearch" placeholder="Search fruits/veggies... (spinach, berries, broccoli)" oninput="searchFoods('veggie')">
            <div class="food-grid" id="veggieGrid"></div>
            <div class="selected-foods">
                <h4>Selected Fruits & Vegetables:</h4>
                <div class="selected-food-tags" id="selectedVeggies"></div>
            </div>
        </div>
    </div>

    <button class="generate-btn" onclick="generateMealPlan()" id="generateBtn">
        üöÄ Generate My Meal Plan
    </button>

    <!-- Meal Plan Output -->
    <div class="meal-plan-output" id="mealPlanOutput">
        <h3 style="color: #4da6d9; text-align: center; margin-bottom: 20px;">Your Personalized Meal Plan</h3>
        <div id="generatedMeals"></div>
        
        <div class="daily-summary">
            <h3 style="color: #2ecc71; text-align: center; margin-bottom: 15px;">Daily Nutrition Summary</h3>
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-number" id="totalProtein">0</div>
                    <div class="summary-label">Protein (g)</div>
                    <div class="progress-bar">
                        <div class="progress-fill protein-fill" id="proteinProgress"></div>
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-number" id="totalCarbs">0</div>
                    <div class="summary-label">Carbs (g)</div>
                    <div class="progress-bar">
                        <div class="progress-fill carbs-fill" id="carbsProgress"></div>
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-number" id="totalFat">0</div>
                    <div class="summary-label">Fat (g)</div>
                    <div class="progress-bar">
                        <div class="progress-fill fat-fill" id="fatProgress"></div>
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-number" id="totalCalories">0</div>
                    <div class="summary-label">Calories</div>
                    <div class="progress-bar">
                        <div class="progress-fill calories-fill" id="caloriesProgress"></div>
                    </div>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="download-btn" onclick="downloadMealPlan()">üì• Download Meal Plan</button>
        </div>
    </div>
</div>

<script>
// Global variables
let selectedFoods = {
    protein: [],
    carb: [],
    fat: [],
    veggie: []
};

let searchTimeout;
let currentMealPlan = null;

// Food classification functions
function getFoodMacroType(food) {
    const protein = food.protein || 0;
    const carbs = food.carbs || 0;
    const fat = food.fat || 0;
    
    const totalMacros = protein * 4 + carbs * 4 + fat * 9;
    if (totalMacros === 0) return 'mixed';
    
    const proteinPercent = (protein * 4 / totalMacros) * 100;
    const carbPercent = (carbs * 4 / totalMacros) * 100;
    const fatPercent = (fat * 9 / totalMacros) * 100;
    
    if (proteinPercent >= 40) return 'protein';
    if (carbPercent >= 50) return 'carb';
    if (fatPercent >= 50) return 'fat';
    return 'mixed';
}

function isVegetableOrFruit(food) {
    const name = food.name.toLowerCase();
    const keywords = ['vegetable', 'fruit', 'berry', 'green', 'spinach', 'lettuce', 'broccoli', 'carrot', 'tomato', 'apple', 'banana', 'orange', 'grape', 'strawberry', 'blueberry'];
    return keywords.some(keyword => name.includes(keyword)) || (food.carbs > 0 && food.carbs < 20 && food.protein < 5);
}

function getMacroBadge(type) {
    const badges = {
        'protein': '<span class="macro-badge protein-badge">PROTEIN</span>',
        'carb': '<span class="macro-badge carb-badge">CARB</span>',
        'fat': '<span class="macro-badge fat-badge">FAT</span>',
        'mixed': '<span class="macro-badge mixed-badge">MIXED</span>'
    };
    return badges[type] || '';
}

// Search foods by category
async function searchFoods(category) {
    const searchInput = document.getElementById(`${category}Search`);
    const grid = document.getElementById(`${category}Grid`);
    const searchTerm = searchInput.value.trim();

    if (searchTerm.length < 2) {
        grid.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">Type 2+ characters to search...</div>';
        return;
    }

    grid.innerHTML = '<div class="loading">üîç Searching USDA database...</div>';

    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
        try {
            const response = await fetch('/api/usda-search-dropdown', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ searchTerm })
            });

            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.foods && data.foods.length > 0) {
                // Filter foods by category
                let filteredFoods = data.foods.filter(food => {
                    const macroType = getFoodMacroType(food);
                    
                    if (category === 'protein') return macroType === 'protein';
                    if (category === 'carb') return macroType === 'carb';
                    if (category === 'fat') return macroType === 'fat';
                    if (category === 'veggie') return isVegetableOrFruit(food);
                    
                    return false;
                });

                // If no exact matches, show mixed foods too
                if (filteredFoods.length === 0) {
                    filteredFoods = data.foods.slice(0, 12);
                }

                displayFoods(category, filteredFoods.slice(0, 12));
            } else {
                grid.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No foods found. Try different keywords.</div>';
            }
        } catch (error) {
            grid.innerHTML = '<div style="color: #e74c3c; text-align: center; padding: 20px;">Search failed. Please try again.</div>';
        }
    }, 500);
}

// Display foods in grid
function displayFoods(category, foods) {
    const grid = document.getElementById(`${category}Grid`);
    
    const foodsHTML = foods.map(food => {
        const macroType = getFoodMacroType(food);
        const badge = getMacroBadge(macroType);
        const isSelected = selectedFoods[category].some(f => f.id === food.id);
        
        let displayName = food.name;
        if (displayName.length > 30) {
            displayName = displayName.substring(0, 30) + '...';
        }
        
        return `
            <div class="food-item ${isSelected ? 'selected' : ''}" onclick="toggleFood('${category}', ${JSON.stringify(food).replace(/"/g, '&quot;')})">
                <div class="food-name">${displayName}</div>
                <div class="food-macros ${isSelected ? 'selected' : ''}">
                    P: ${food.protein.toFixed(1)}g | C: ${food.carbs.toFixed(1)}g | F: ${food.fat.toFixed(1)}g
                </div>
                <div class="food-badges">${badge}</div>
            </div>
        `;
    }).join('');
    
    grid.innerHTML = foodsHTML;
}

// Toggle food selection
function toggleFood(category, food) {
    const existingIndex = selectedFoods[category].findIndex(f => f.id === food.id);
    
    if (existingIndex >= 0) {
        selectedFoods[category].splice(existingIndex, 1);
    } else {
        selectedFoods[category].push(food);
    }
    
    updateSelectedFoodsDisplay(category);
    updateGenerateButton();
}

// Update selected foods display
function updateSelectedFoodsDisplay(category) {
    const container = document.getElementById(`selected${category.charAt(0).toUpperCase() + category.slice(1)}s`);
    
    const tagsHTML = selectedFoods[category].map(food => {
        let displayName = food.name;
        if (displayName.length > 25) {
            displayName = displayName.substring(0, 25) + '...';
        }
        
        return `
            <div class="selected-food-tag" onclick="removeFood('${category}', '${food.id}')" title="Click to remove">
                ${displayName} ‚úï
            </div>
        `;
    }).join('');
    
    container.innerHTML = tagsHTML || '<span style="color: #666;">None selected</span>';
}

// Remove food from selection
function removeFood(category, foodId) {
    selectedFoods[category] = selectedFoods[category].filter(f => f.id !== foodId);
    updateSelectedFoodsDisplay(category);
    updateGenerateButton();
    
    // Update the grid display
    const searchInput = document.getElementById(`${category}Search`);
    if (searchInput.value.trim().length >= 2) {
        searchFoods(category);
    }
}

// Update generate button state
function updateGenerateButton() {
    const btn = document.getElementById('generateBtn');
    const hasSelections = Object.values(selectedFoods).some(arr => arr.length > 0);
    
    btn.disabled = !hasSelections;
    btn.innerHTML = hasSelections ? 'üöÄ Generate My Meal Plan' : '‚ö†Ô∏è Please select some foods first';
}

// Generate meal plan
async function generateMealPlan() {
    const btn = document.getElementById('generateBtn');
    const output = document.getElementById('mealPlanOutput');
    
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Generating your meal plan...';
    
    // Get targets
    const targetProtein = parseFloat(document.getElementById('targetProtein').value) || 150;
    const targetCarbs = parseFloat(document.getElementById('targetCarbs').value) || 200;
    const targetFat = parseFloat(document.getElementById('targetFat').value) || 60;
    const mealsCount = parseInt(document.getElementById('mealsCount').value) || 4;
    
    // Calculate per-meal targets
    const proteinPerMeal = targetProtein / mealsCount;
    const carbsPerMeal = targetCarbs / mealsCount;
    const fatPerMeal = targetFat / mealsCount;
    
    try {
        // Generate meal plan
        const mealPlan = await buildMealPlan({
            targetProtein,
            targetCarbs,
            targetFat,
            mealsCount,
            proteinPerMeal,
            carbsPerMeal,
            fatPerMeal,
            selectedFoods
        });
        
        currentMealPlan = mealPlan;
        displayMealPlan(mealPlan);
        
        output.classList.add('active');
        output.scrollIntoView({ behavior: 'smooth' });
        
    } catch (error) {
        alert('Error generating meal plan. Please try again.');
        console.error(error);
    }
    
    btn.disabled = false;
    btn.innerHTML = 'üöÄ Generate My Meal Plan';
}

// Build meal plan algorithm
async function buildMealPlan(params) {
    const { mealsCount, proteinPerMeal, carbsPerMeal, fatPerMeal, selectedFoods } = params;
    const mealPlan = [];
    
    const mealNames = ['Breakfast', 'Lunch', 'Dinner', 'Snack', 'Pre-Workout', 'Post-Workout'];
    
    for (let i = 0; i < mealsCount; i++) {
        const meal = {
            name: mealNames[i] || `Meal ${i + 1}`,
            foods: [],
            totals: { protein: 0, carbs: 0, fat: 0, calories: 0 }
        };
        
        // Add protein source
        if (selectedFoods.protein.length > 0) {
            const protein = selectedFoods.protein[i % selectedFoods.protein.length];
            const quantity = calculateQuantity(protein, 'protein', proteinPerMeal);
            meal.foods.push({ food: protein, quantity, type: 'protein' });
        }
        
        // Add carb source
        if (selectedFoods.carb.length > 0) {
            const carb = selectedFoods.carb[i % selectedFoods.carb.length];
            const quantity = calculateQuantity(carb, 'carbs', carbsPerMeal);
            meal.foods.push({ food: carb, quantity, type: 'carb' });
        }
        
        // Add fat source
        if (selectedFoods.fat.length > 0) {
            const fat = selectedFoods.fat[i % selectedFoods.fat.length];
            const quantity = calculateQuantity(fat, 'fat', fatPerMeal * 0.7); // Reduce fat slightly as other foods contribute
            meal.foods.push({ food: fat, quantity, type: 'fat' });
        }
        
        // Add vegetable/fruit
        if (selectedFoods.veggie.length > 0) {
            const veggie = selectedFoods.veggie[i % selectedFoods.veggie.length];
            const quantity = 100; // Standard serving
            meal.foods.push({ food: veggie, quantity, type: 'veggie' });
        }
        
        // Calculate meal totals
        meal.foods.forEach(item => {
            const multiplier = item.quantity / 100;
            meal.totals.protein += item.food.protein * multiplier;
            meal.totals.carbs += item.food.carbs * multiplier;
            meal.totals.fat += item.food.fat * multiplier;
            meal.totals.calories += item.food.calories * multiplier;
        });
        
        mealPlan.push(meal);
    }
    
    return mealPlan;
}

// Calculate optimal quantity for target macro
function calculateQuantity(food, macro, target) {
    const macroValue = food[macro] || 1;
    if (macroValue === 0) return 100; // Default quantity if no macro content
    
    const quantity = (target / macroValue) * 100;
    
    // Keep quantities reasonable (between 50g and 500g)
    return Math.max(50, Math.min(500, Math.round(quantity)));
}

// Display generated meal plan
function displayMealPlan(mealPlan) {
    const container = document.getElementById('generatedMeals');
    
    const mealsHTML = mealPlan.map((meal, index) => {
        const foodsHTML = meal.foods.map(item => {
            const macroType = getFoodMacroType(item.food);
            const badge = getMacroBadge(macroType);
            
            const multiplier = item.quantity / 100;
            const itemProtein = (item.food.protein * multiplier).toFixed(1);
            const itemCarbs = (item.food.carbs * multiplier).toFixed(1);
            const itemFat = (item.food.fat * multiplier).toFixed(1);
            const itemCalories = (item.food.calories * multiplier).toFixed(0);
            
            return `
                <div class="meal-food">
                    <div class="food-details">
                        <div class="food-info">
                            <div style="font-weight: bold;">${item.food.name} ${badge}</div>
                            <div class="food-nutrition">P: ${itemProtein}g | C: ${itemCarbs}g | F: ${itemFat}g | Cal: ${itemCalories}</div>
                        </div>
                        <div class="food-quantity">${item.quantity}g</div>
                    </div>
                </div>
            `;
        }).join('');
        
        return `
            <div class="meal-section">
                <div class="meal-header">Meal ${index + 1}: ${meal.name}</div>
                ${foodsHTML}
                <div class="meal-totals">
                    <strong>Meal Totals:</strong> 
                    P: ${meal.totals.protein.toFixed(1)}g | 
                    C: ${meal.totals.carbs.toFixed(1)}g | 
                    F: ${meal.totals.fat.toFixed(1)}g | 
                    Cal: ${meal.totals.calories.toFixed(0)}
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = mealsHTML;
    
    // Update daily summary
    updateDailySummary(mealPlan);
}

// Update daily summary
function updateDailySummary(mealPlan) {
    const dailyTotals = mealPlan.reduce((totals, meal) => {
        totals.protein += meal.totals.protein;
        totals.carbs += meal.totals.carbs;
        totals.fat += meal.totals.fat;
        totals.calories += meal.totals.calories;
        return totals;
    }, { protein: 0, carbs: 0, fat: 0, calories: 0 });
    
    // Update display
    document.getElementById('totalProtein').textContent = dailyTotals.protein.toFixed(1);
    document.getElementById('totalCarbs').textContent = dailyTotals.carbs.toFixed(1);
    document.getElementById('totalFat').textContent = dailyTotals.fat.toFixed(1);
    document.getElementById('totalCalories').textContent = dailyTotals.calories.toFixed(0);
    
    // Update progress bars
    const targetProtein = parseFloat(document.getElementById('targetProtein').value) || 1;
    const targetCarbs = parseFloat(document.getElementById('targetCarbs').value) || 1;
    const targetFat = parseFloat(document.getElementById('targetFat').value) || 1;
    const targetCalories = targetProtein * 4 + targetCarbs * 4 + targetFat * 9;
    
    document.getElementById('proteinProgress').style.width = Math.min(100, (dailyTotals.protein / targetProtein) * 100) + '%';
    document.getElementById('carbsProgress').style.width = Math.min(100, (dailyTotals.carbs / targetCarbs) * 100) + '%';
    document.getElementById('fatProgress').style.width = Math.min(100, (dailyTotals.fat / targetFat) * 100) + '%';
    document.getElementById('caloriesProgress').style.width = Math.min(100, (dailyTotals.calories / targetCalories) * 100) + '%';
}

// Download meal plan
function downloadMealPlan() {
    if (!currentMealPlan) return;
    
    const today = new Date();
    const formattedDate = today.toLocaleDateString("en-CA");
    
    const wrapper = document.createElement("div");
    wrapper.style.background = "#fff";
    wrapper.style.color = "#000";
    wrapper.style.padding = "40px";
    wrapper.style.fontFamily = "Arial, sans-serif";
    wrapper.style.maxWidth = "800px";
    wrapper.style.lineHeight = "1.6";

    const title = document.createElement("h2");
    title.innerText = `BUILT AUTOMATED MEAL PLAN ‚Äì ${formattedDate}`;
    title.style.textAlign = "center";
    title.style.marginBottom = "30px";
    title.style.color = "#000";

    let content = '';
    
    // Add meal plan content
    currentMealPlan.forEach((meal, index) => {
        content += `\nMEAL ${index + 1}: ${meal.name.toUpperCase()}\n`;
        content += '‚îÄ'.repeat(50) + '\n';
        
        meal.foods.forEach(item => {
            const multiplier = item.quantity / 100;
            content += `‚Ä¢ ${item.quantity}g ${item.food.name}\n`;
            content += `  P: ${(item.food.protein * multiplier).toFixed(1)}g | C: ${(item.food.carbs * multiplier).toFixed(1)}g | F: ${(item.food.fat * multiplier).toFixed(1)}g | Cal: ${(item.food.calories * multiplier).toFixed(0)}\n`;
        });
        
        content += `\nMeal Totals: P: ${meal.totals.protein.toFixed(1)}g | C: ${meal.totals.carbs.toFixed(1)}g | F: ${meal.totals.fat.toFixed(1)}g | Cal: ${meal.totals.calories.toFixed(0)}\n\n`;
    });
    
    // Add daily totals
    const dailyTotals = currentMealPlan.reduce((totals, meal) => {
        totals.protein += meal.totals.protein;
        totals.carbs += meal.totals.carbs;
        totals.fat += meal.totals.fat;
        totals.calories += meal.totals.calories;
        return totals;
    }, { protein: 0, carbs: 0, fat: 0, calories: 0 });
    
    content += '\n' + '‚ïê'.repeat(60) + '\n';
    content += 'DAILY TOTALS:\n';
    content += `Protein: ${dailyTotals.protein.toFixed(1)}g / ${document.getElementById('targetProtein').value}g\n`;
    content += `Carbs: ${dailyTotals.carbs.toFixed(1)}g / ${document.getElementById('targetCarbs').value}g\n`;
    content += `Fat: ${dailyTotals.fat.toFixed(1)}g / ${document.getElementById('targetFat').value}g\n`;
    content += `Calories: ${dailyTotals.calories.toFixed(0)}\n\n`;
    content += '* Generated from USDA FoodData Central database\n';
    content += '* Quantities automatically calculated to meet your macro targets';

    const contentEl = document.createElement("pre");
    contentEl.innerText = content;
    contentEl.style.whiteSpace = "pre-wrap";
    contentEl.style.fontSize = "11px";
    contentEl.style.color = "#000";

    wrapper.appendChild(title);
    wrapper.appendChild(contentEl);
    document.body.appendChild(wrapper);

    html2canvas(wrapper, { scale: 2 }).then(canvas => {
        const link = document.createElement("a");
        link.download = `BUILT_Automated_Meal_Plan_${formattedDate.replace(/\s/g, "_")}.png`;
        link.href = canvas.toDataURL();
        link.click();
        document.body.removeChild(wrapper);
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateGenerateButton();
});
</script>
</body>
</html>

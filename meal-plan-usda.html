<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BUILT Automated Meal Plan Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        .container {
            max-width: 1000px;
            margin: auto;
            font-family: 'Arial Black', Arial, sans-serif;
            padding: 20px;
            background-color: #1A1A1A;
            color: #FFFFFF;
            border-radius: 8px;
        }

        .section {
            background: #000000;
            padding: 25px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #6B7280;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
        }

        .section-title {
            color: #FFFFFF;
            font-weight: 900;
            margin-bottom: 15px;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid #DC2626;
            padding-bottom: 8px;
        }

        .macro-inputs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .macro-input {
            text-align: center;
        }

        .macro-input label {
            display: block;
            font-size: 14px;
            color: #FFFFFF;
            margin-bottom: 5px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .macro-input input {
            width: 100%;
            padding: 12px;
            background: #1A1A1A;
            color: #FFFFFF;
            border: 2px solid #6B7280;
            border-radius: 4px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            transition: border-color 0.2s ease;
        }

        .macro-input input:focus {
            outline: none;
            border-color: #DC2626;
            box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.2);
        }

        .food-category {
            margin-bottom: 20px;
        }

        .category-title {
            color: #FFFFFF;
            font-weight: 900;
            margin-bottom: 10px;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .food-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #6B7280;
            border-radius: 4px;
            padding: 15px;
            background: #1A1A1A;
        }

        .food-item {
            background: #000000;
            padding: 12px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid #6B7280;
            transition: all 0.2s ease;
            font-size: 12px;
            font-weight: 600;
        }

        .food-item:hover {
            background: #1A1A1A;
            border-color: #FFFFFF;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.8);
        }

        .food-item.selected {
            background: #DC2626;
            color: #FFFFFF;
            border-color: #DC2626;
            box-shadow: 0 4px 16px rgba(220, 38, 38, 0.4);
        }

        .food-item.not-appropriate {
            opacity: 0.6;
            border-left: 4px solid #6B7280;
        }

        .food-item.not-appropriate:hover {
            opacity: 1;
            background: #1A1A1A;
            border-color: #6B7280;
        }

        .food-name {
            font-weight: 900;
            margin-bottom: 5px;
            font-size: 12px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .food-macros {
            font-size: 10px;
            color: #6B7280;
            font-weight: 600;
        }

        .selected .food-macros {
            color: #FFFFFF;
        }

        .food-badges {
            display: flex;
            gap: 5px;
            margin-top: 6px;
        }

        .macro-badge {
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 8px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .protein-badge { background: #DC2626; color: #FFFFFF; }
        .carb-badge { background: #6B7280; color: #FFFFFF; }
        .fat-badge { background: #000000; color: #FFFFFF; border: 1px solid #6B7280; }
        .mixed-badge { background: #1A1A1A; color: #FFFFFF; border: 1px solid #6B7280; }

        .selected-foods {
            margin-top: 15px;
            padding: 15px;
            background: #1A1A1A;
            border-radius: 4px;
            border: 2px solid #6B7280;
        }

        .selected-foods h4 {
            color: #FFFFFF;
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .selected-food-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .selected-food-tag {
            background: #DC2626;
            color: #FFFFFF;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }

        .selected-food-tag:hover {
            background: #000000;
            border: 2px solid #DC2626;
            transform: translateY(-1px);
        }

        .generate-btn {
            width: 100%;
            padding: 20px;
            font-size: 18px;
            background: #DC2626;
            color: #FFFFFF;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 900;
            margin: 25px 0;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
        }

        .generate-btn:hover {
            background: #FFFFFF;
            color: #DC2626;
            border: 2px solid #DC2626;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(220, 38, 38, 0.4);
        }

        .generate-btn:disabled {
            background: #6B7280;
            color: #1A1A1A;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            border: none;
        }

        .meal-plan-output {
            display: none;
            background: #000000;
            padding: 25px;
            border-radius: 4px;
            border: 2px solid #DC2626;
            margin-top: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
        }

        .meal-plan-output.active {
            display: block;
        }

        .meal-section {
            background: #1A1A1A;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 2px solid #6B7280;
        }

        .meal-header {
            color: #FFFFFF;
            font-weight: 900;
            font-size: 16px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #DC2626;
            padding-bottom: 8px;
        }

        .meal-food {
            background: #000000;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 10px;
            border-left: 4px solid #DC2626;
            border: 1px solid #6B7280;
        }

        .food-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .food-info {
            flex: 1;
        }

        .food-quantity {
            font-weight: 900;
            color: #DC2626;
            font-size: 16px;
        }

        .food-nutrition {
            font-size: 12px;
            color: #6B7280;
            margin-top: 4px;
            font-weight: 600;
        }

        .meal-totals {
            background: #1A1A1A;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 13px;
            border: 2px solid #DC2626;
            font-weight: 700;
            color: #FFFFFF;
        }

        .daily-summary {
            background: #1A1A1A;
            padding: 25px;
            border-radius: 4px;
            margin-top: 25px;
            border: 2px solid #6B7280;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            text-align: center;
        }

        .summary-item {
            background: #000000;
            padding: 20px;
            border-radius: 4px;
            border: 2px solid #6B7280;
        }

        .summary-number {
            font-size: 28px;
            font-weight: 900;
            color: #FFFFFF;
        }

        .summary-label {
            font-size: 12px;
            color: #6B7280;
            margin-top: 8px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-bar {
            background: #1A1A1A;
            height: 8px;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
            border: 1px solid #6B7280;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .protein-fill { background: #DC2626; }
        .carbs-fill { background: #6B7280; }
        .fat-fill { background: #FFFFFF; }
        .calories-fill { background: #6B7280; }

        .download-btn {
            background: #DC2626;
            color: #FFFFFF;
            border: none;
            padding: 15px 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }

        .download-btn:hover {
            background: #FFFFFF;
            color: #DC2626;
            border: 2px solid #DC2626;
            transform: translateY(-2px);
        }

        /* Mode Toggle Styles */
        .mode-toggle {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .mode-btn {
            background: #1A1A1A;
            color: #6B7280;
            border: 2px solid #6B7280;
            padding: 15px 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 900;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .mode-btn.active {
            background: #DC2626;
            color: #FFFFFF;
            border-color: #DC2626;
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            background: #FFFFFF;
            color: #1A1A1A;
            border-color: #FFFFFF;
        }

        .mode-btn.active:hover {
            background: #FFFFFF;
            color: #DC2626;
            border-color: #DC2626;
        }

        /* Meal Tabs Styles */
        .meal-tabs {
            margin-top: 20px;
        }

        .tab-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #6B7280;
            padding-bottom: 15px;
        }

        .tab-btn {
            background: #1A1A1A;
            color: #6B7280;
            border: 2px solid #6B7280;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 900;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tab-btn.active {
            background: #DC2626;
            color: #FFFFFF;
            border-color: #DC2626;
        }

        .tab-btn:hover {
            background: #FFFFFF;
            color: #1A1A1A;
            border-color: #FFFFFF;
        }

        .tab-btn.active:hover {
            background: #FFFFFF;
            color: #DC2626;
            border-color: #DC2626;
        }

        .meal-tab-content {
            display: none;
        }

        .meal-tab-content.active {
            display: block;
        }

        .meal-title {
            color: #FFFFFF;
            font-weight: 900;
            font-size: 20px;
            margin-bottom: 20px;
            text-align: center;
            padding: 20px;
            background: #1A1A1A;
            border-radius: 4px;
            border: 2px solid #DC2626;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .meal-food-categories {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .compact-food-category {
            background: #1A1A1A;
            padding: 20px;
            border-radius: 4px;
            border: 2px solid #6B7280;
        }

        .compact-category-title {
            color: #FFFFFF;
            font-weight: 900;
            margin-bottom: 15px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .compact-food-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 15px;
            background: #000000;
            border-radius: 4px;
            border: 2px solid #6B7280;
        }

        .compact-selected-foods {
            margin-top: 15px;
            padding: 12px;
            background: #000000;
            border-radius: 4px;
            border: 2px solid #6B7280;
        }

        .compact-selected-foods h5 {
            color: #FFFFFF;
            margin: 0 0 8px 0;
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
<div class="container">
    <h2 style="text-align: center; color: #FFFFFF; margin-bottom: 10px; font-weight: 900; font-size: 32px; text-transform: uppercase; letter-spacing: 2px;">BUILT AUTOMATED MEAL PLAN GENERATOR</h2>
    <p style="text-align: center; margin-bottom: 30px; color: #6B7280; font-weight: 700; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">Professional meal planning with 54 USDA-verified foods • <span style="color: #DC2626; font-weight: 900; text-shadow: 0 0 5px #DC2626;">SMART MEAL ASSIGNMENT - 99%+ ACCURACY 🧠</span></p>

    <!-- Macro Targets -->
    <div class="section">
        <div class="section-title">📊 DAILY MACRO TARGETS</div>
        <div class="macro-inputs">
            <div class="macro-input">
                <label>PROTEIN (G)</label>
                <input type="number" id="targetProtein" value="150" min="50" max="400">
            </div>
            <div class="macro-input">
                <label>CARBS (G)</label>
                <input type="number" id="targetCarbs" value="200" min="50" max="600">
            </div>
            <div class="macro-input">
                <label>FATS (G)</label>
                <input type="number" id="targetFat" value="60" min="20" max="200">
            </div>
            <div class="macro-input">
                <label>MEALS</label>
                <input type="number" id="mealsCount" value="4" min="3" max="6" onchange="updateMealTabs()">
            </div>
        </div>
    </div>

    <!-- Food Preferences -->
    <div class="section">
        <div class="section-title">🍽️ NUTRITION SOURCES</div>
        <p style="color: #6B7280; font-size: 12px; margin-bottom: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">CHOOSE YOUR FOOD SELECTION METHOD.</p>
        
        <!-- Mode Toggle -->
        <div class="mode-toggle">
            <button id="quickSetupBtn" class="mode-btn active" onclick="switchToQuickSetup()">
                ⚡ Quick Setup
            </button>
            <button id="customMealsBtn" class="mode-btn" onclick="switchToCustomMeals()">
                🎯 Custom Per Meal
            </button>
        </div>

        <!-- Quick Setup Mode (Original) -->
        <div id="quickSetupMode">
            <p style="color: #6B7280; font-size: 12px; margin-bottom: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">SELECT YOUR PREFERRED FOODS. SYSTEM WILL AUTOMATICALLY ASSIGN TO OPTIMAL MEALS.</p>
            
            <!-- Proteins -->
            <div class="food-category">
                <div class="category-title">🥩 PROTEIN SOURCES</div>
                <div class="food-grid" id="proteinGrid"></div>
                <div class="selected-foods">
                    <h4>SELECTED PROTEINS:</h4>
                    <div class="selected-food-tags" id="selectedProteins"></div>
                </div>
            </div>

            <!-- Carbs -->
            <div class="food-category">
                <div class="category-title">🍚 CARBOHYDRATE SOURCES</div>
                <div class="food-grid" id="carbGrid"></div>
                <div class="selected-foods">
                    <h4>SELECTED CARBS:</h4>
                    <div class="selected-food-tags" id="selectedCarbs"></div>
                </div>
            </div>

            <!-- Fats -->
            <div class="food-category">
                <div class="category-title">🥑 FAT SOURCES</div>
                <div class="food-grid" id="fatGrid"></div>
                <div class="selected-foods">
                    <h4>SELECTED FATS:</h4>
                    <div class="selected-food-tags" id="selectedFats"></div>
                </div>
            </div>

            <!-- Fruits & Vegetables -->
            <div class="food-category">
                <div class="category-title">🥬 FRUITS & VEGETABLES</div>
                <div class="food-grid" id="veggieGrid"></div>
                <div class="selected-foods">
                    <h4>SELECTED FRUITS & VEGETABLES:</h4>
                    <div class="selected-food-tags" id="selectedVeggies"></div>
                </div>
            </div>
        </div>

        <!-- Custom Per Meal Mode -->
        <div id="customMealsMode" style="display: none;">
            <p style="color: #6B7280; font-size: 12px; margin-bottom: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">SELECT SPECIFIC FOODS FOR EACH MEAL. FOODS MARKED WITH ⚠️ ARE ATYPICAL BUT SELECTABLE.</p>
            
            <div class="meal-tabs">
                <div class="tab-buttons" id="mealTabButtons"></div>
                <div class="tab-content" id="mealTabContent"></div>
            </div>
        </div>
    </div>

    <button class="generate-btn" onclick="generateMealPlan()" id="generateBtn">
        🚀 Generate My Meal Plan
    </button>

    <!-- Meal Plan Output -->
    <div class="meal-plan-output" id="mealPlanOutput">
        <h3 style="color: #FFFFFF; text-align: center; margin-bottom: 20px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px;">YOUR PERSONALIZED MEAL PLAN</h3>
        <div id="generatedMeals"></div>
        
        <div class="daily-summary">
            <h3 style="color: #DC2626; text-align: center; margin-bottom: 15px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px;">DAILY NUTRITION SUMMARY - SMART MEAL ASSIGNMENT 🧠</h3>
            <p style="text-align: center; color: #6B7280; margin-bottom: 15px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">MEALS BALANCED TO ±30% AVERAGE SIZE • FOODS INTELLIGENTLY ASSIGNED BY MEAL TYPE</p>
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-number" id="totalProtein">0</div>
                    <div class="summary-label">PROTEIN (G)<br><small style="color: #DC2626; font-weight: 900;">👑 = 99%+ | ✓ = 95%+</small></div>
                    <div class="progress-bar">
                        <div class="progress-fill protein-fill" id="proteinProgress"></div>
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-number" id="totalCarbs">0</div>
                    <div class="summary-label">CARBS (G)<br><small style="color: #DC2626; font-weight: 900;">👑 = 99%+ | ✓ = 95%+</small></div>
                    <div class="progress-bar">
                        <div class="progress-fill carbs-fill" id="carbsProgress"></div>
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-number" id="totalFat">0</div>
                    <div class="summary-label">FAT (G)<br><small style="color: #DC2626; font-weight: 900;">👑 = 99%+ | ✓ = 95%+</small></div>
                    <div class="progress-bar">
                        <div class="progress-fill fat-fill" id="fatProgress"></div>
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-number" id="totalCalories">0</div>
                    <div class="summary-label">CALORIES</div>
                    <div class="progress-bar">
                        <div class="progress-fill calories-fill" id="caloriesProgress"></div>
                    </div>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="download-btn" onclick="downloadMealPlan()">📥 DOWNLOAD MEAL PLAN</button>
        </div>
    </div>
</div>

<script>
// Complete USDA Food Database - Built-in with accurate nutrition data + MEAL APPROPRIATENESS
let foodDatabase = {
    protein: [
        { id: 'p1', name: 'Chicken Breast', protein: 31.0, carbs: 0.0, fat: 3.6, calories: 165, state: 'cooked', meals: ['lunch', 'dinner'] },
        { id: 'p2', name: 'Chicken Thigh', protein: 24.8, carbs: 0.0, fat: 8.2, calories: 179, state: 'cooked', meals: ['lunch', 'dinner'] },
        { id: 'p3', name: 'Extra Lean Ground Turkey', protein: 22.0, carbs: 0.0, fat: 7.0, calories: 149, state: 'cooked', meals: ['lunch', 'dinner'] },
        { id: 'p4', name: 'Turkey Breast', protein: 29.9, carbs: 0.0, fat: 0.7, calories: 135, state: 'cooked', meals: ['lunch', 'dinner'] },
        { id: 'p5', name: 'Sirloin Roast', protein: 26.1, carbs: 0.0, fat: 8.4, calories: 185, state: 'cooked', meals: ['lunch', 'dinner'] },
        { id: 'p6', name: 'Extra Lean Ground Beef', protein: 26.1, carbs: 0.0, fat: 5.0, calories: 158, state: 'cooked', meals: ['lunch', 'dinner'] },
        { id: 'p7', name: 'Sirloin Steak', protein: 26.0, carbs: 0.0, fat: 6.1, calories: 170, state: 'cooked', meals: ['lunch', 'dinner'] },
        { id: 'p8', name: 'Extra Lean Ground Bison', protein: 28.4, carbs: 0.0, fat: 2.4, calories: 138, state: 'cooked', meals: ['lunch', 'dinner'] },
        { id: 'p9', name: 'Cod', protein: 22.4, carbs: 0.0, fat: 1.2, calories: 106, state: 'cooked', meals: ['lunch', 'dinner'] },
        { id: 'p10', name: 'Salmon', protein: 25.4, carbs: 0.0, fat: 11.6, calories: 206, state: 'cooked', meals: ['breakfast', 'lunch', 'dinner'] },
        { id: 'p11', name: 'Shrimp', protein: 23.3, carbs: 1.6, fat: 1.7, calories: 101, state: 'cooked', meals: ['lunch', 'dinner'] },
        { id: 'p12', name: '2% Greek Yogurt (plain)', protein: 10.0, carbs: 3.9, fat: 2.0, calories: 81, state: 'ready', meals: ['breakfast', 'snack'] },
        { id: 'p13', name: '0% Greek Yogurt (plain)', protein: 10.3, carbs: 3.6, fat: 0.4, calories: 59, state: 'ready', meals: ['breakfast', 'snack'] },
        { id: 'p14', name: 'Liquid Egg Whites', protein: 10.9, carbs: 0.7, fat: 0.2, calories: 52, state: 'liquid', meals: ['breakfast'] },
        { id: 'p15', name: 'Whole Egg', protein: 12.6, carbs: 0.7, fat: 9.9, calories: 147, state: 'cooked', meals: ['breakfast'] },
        { id: 'p16', name: 'Whey Isolate Protein Powder', protein: 90.0, carbs: 0.0, fat: 0.5, calories: 375, state: 'powder', meals: ['breakfast', 'snack', 'pre-workout', 'post-workout'] },
        { id: 'p17', name: 'Vegan Protein Powder', protein: 75.0, carbs: 8.0, fat: 2.5, calories: 370, state: 'powder', meals: ['breakfast', 'snack', 'pre-workout', 'post-workout'] }
    ],
    carb: [
        { id: 'c1', name: 'White Jasmine Rice', protein: 2.7, carbs: 28.6, fat: 0.3, calories: 130, state: 'cooked', meals: ['lunch', 'dinner'] },
        { id: 'c2', name: 'White Basmati Rice', protein: 2.7, carbs: 28.0, fat: 0.3, calories: 130, state: 'cooked', meals: ['lunch', 'dinner'] },
        { id: 'c3', name: 'Golden Potato', protein: 2.5, carbs: 21.0, fat: 0.1, calories: 93, state: 'cooked', meals: ['breakfast', 'lunch', 'dinner'] },
        { id: 'c4', name: 'White Potato', protein: 2.5, carbs: 21.0, fat: 0.1, calories: 93, state: 'cooked', meals: ['breakfast', 'lunch', 'dinner'] },
        { id: 'c5', name: 'Sweet Potato', protein: 1.6, carbs: 20.1, fat: 0.1, calories: 86, state: 'cooked', meals: ['lunch', 'dinner'] },
        { id: 'c6', name: 'Pasta', protein: 5.0, carbs: 25.0, fat: 0.9, calories: 131, state: 'cooked', meals: ['lunch', 'dinner'] },
        { id: 'c7', name: 'Sourdough Bread', protein: 9.0, carbs: 48.0, fat: 2.5, calories: 259, state: 'ready', meals: ['breakfast', 'lunch', 'snack'] },
        { id: 'c8', name: 'Cream of Rice', protein: 1.5, carbs: 22.0, fat: 0.1, calories: 95, state: 'cooked', meals: ['breakfast', 'post-workout'] },
        { id: 'c9', name: 'Cream of Wheat', protein: 2.5, carbs: 22.0, fat: 0.5, calories: 105, state: 'cooked', meals: ['breakfast', 'post-workout'] },
        { id: 'c10', name: 'Oats', protein: 16.9, carbs: 66.3, fat: 6.9, calories: 389, state: 'dry', meals: ['breakfast'] },
        { id: 'c11', name: 'Special K Red Berries Cereal', protein: 6.0, carbs: 84.0, fat: 1.0, calories: 375, state: 'dry', meals: ['breakfast'] },
        { id: 'c12', name: 'Vector Cereal', protein: 12.0, carbs: 72.0, fat: 3.0, calories: 380, state: 'dry', meals: ['breakfast'] },
        { id: 'c13', name: 'All Bran Buds Cereal', protein: 10.0, carbs: 72.0, fat: 4.0, calories: 320, state: 'dry', meals: ['breakfast'] },
        { id: 'c14', name: 'Granola', protein: 10.1, carbs: 65.4, fat: 12.8, calories: 421, state: 'ready', meals: ['breakfast', 'snack'] }
    ],
    fat: [
        { id: 'f1', name: 'Natural Peanut Butter', protein: 25.1, carbs: 20.0, fat: 50.4, calories: 588, state: 'spread', meals: ['breakfast', 'snack'] },
        { id: 'f2', name: 'Natural Almond Butter', protein: 21.2, carbs: 18.8, fat: 55.5, calories: 614, state: 'spread', meals: ['breakfast', 'snack'] },
        { id: 'f3', name: 'Coconut Oil', protein: 0.0, carbs: 0.0, fat: 99.1, calories: 862, state: 'solid', meals: ['breakfast', 'lunch', 'dinner'] },
        { id: 'f4', name: 'Avocado Oil', protein: 0.0, carbs: 0.0, fat: 100.0, calories: 884, state: 'liquid', meals: ['breakfast', 'lunch', 'dinner'] },
        { id: 'f5', name: 'Extra Virgin Olive Oil', protein: 0.0, carbs: 0.0, fat: 100.0, calories: 884, state: 'liquid', meals: ['lunch', 'dinner'] },
        { id: 'f6', name: 'Avocado', protein: 2.0, carbs: 8.5, fat: 14.7, calories: 160, state: 'raw', meals: ['breakfast', 'lunch', 'snack'] },
        { id: 'f7', name: 'Dark Chocolate 80%', protein: 7.8, carbs: 45.9, fat: 35.4, calories: 501, state: 'solid', meals: ['snack'] },
        { id: 'f8', name: 'Walnuts', protein: 15.2, carbs: 13.7, fat: 65.2, calories: 654, state: 'raw', meals: ['breakfast', 'snack'] },
        { id: 'f9', name: 'Almonds', protein: 21.2, carbs: 21.6, fat: 49.9, calories: 579, state: 'raw', meals: ['breakfast', 'snack'] },
        { id: 'f10', name: 'Cashews', protein: 18.2, carbs: 30.2, fat: 43.9, calories: 553, state: 'raw', meals: ['breakfast', 'snack'] }
    ],
    veggie: [
        { id: 'fr1', name: 'Triple Berry Mix (Frozen)', protein: 0.7, carbs: 12.0, fat: 0.4, calories: 57, state: 'frozen', meals: ['breakfast', 'snack'] },
        { id: 'fr2', name: 'Blueberries (Frozen)', protein: 0.7, carbs: 14.5, fat: 0.3, calories: 57, state: 'frozen', meals: ['breakfast', 'snack'] },
        { id: 'fr3', name: 'Strawberries', protein: 0.7, carbs: 7.7, fat: 0.3, calories: 32, state: 'raw', meals: ['breakfast', 'snack'] },
        { id: 'fr4', name: 'Apple', protein: 0.3, carbs: 14.0, fat: 0.2, calories: 52, state: 'raw', meals: ['breakfast', 'snack'] },
        { id: 'fr5', name: 'Banana', protein: 1.1, carbs: 22.8, fat: 0.3, calories: 89, state: 'raw', meals: ['breakfast', 'snack', 'pre-workout', 'post-workout'] },
        { id: 'fr6', name: 'Cucumber', protein: 0.7, carbs: 3.6, fat: 0.1, calories: 16, state: 'raw', meals: ['lunch', 'dinner', 'snack'] },
        { id: 'v1', name: 'Baby Carrots', protein: 0.9, carbs: 9.6, fat: 0.2, calories: 41, state: 'raw', meals: ['lunch', 'dinner', 'snack'] },
        { id: 'v2', name: 'Zucchini', protein: 1.2, carbs: 3.1, fat: 0.3, calories: 17, state: 'raw', meals: ['lunch', 'dinner'] },
        { id: 'v3', name: 'Bell Peppers', protein: 1.0, carbs: 7.0, fat: 0.3, calories: 31, state: 'raw', meals: ['lunch', 'dinner'] },
        { id: 'v4', name: 'Asparagus', protein: 2.4, carbs: 3.9, fat: 0.2, calories: 22, state: 'cooked', meals: ['lunch', 'dinner'] },
        { id: 'v5', name: 'Green Beans', protein: 1.8, carbs: 7.0, fat: 0.1, calories: 31, state: 'cooked', meals: ['lunch', 'dinner'] },
        { id: 'v6', name: 'Spinach', protein: 2.9, carbs: 3.6, fat: 0.4, calories: 23, state: 'cooked', meals: ['breakfast', 'lunch', 'dinner'] },
        { id: 'v7', name: 'Kale', protein: 2.9, carbs: 5.6, fat: 0.4, calories: 28, state: 'cooked', meals: ['breakfast', 'lunch', 'dinner'] }
    ]
};

// Global variables
let selectedFoods = {
    protein: [],
    carb: [],
    fat: [],
    veggie: []
};

// Meal-specific selections for custom mode
let mealSpecificFoods = {};

let currentMealPlan = null;
let isCustomMealMode = false;
let currentMealTab = 'breakfast';

// Food classification functions
function getFoodMacroType(food) {
    const protein = food.protein || 0;
    const carbs = food.carbs || 0;
    const fat = food.fat || 0;
    
    const totalMacros = protein * 4 + carbs * 4 + fat * 9;
    if (totalMacros === 0) return 'mixed';
    
    const proteinPercent = (protein * 4 / totalMacros) * 100;
    const carbPercent = (carbs * 4 / totalMacros) * 100;
    const fatPercent = (fat * 9 / totalMacros) * 100;
    
    if (proteinPercent >= 40) return 'protein';
    if (carbPercent >= 50) return 'carb';
    if (fatPercent >= 50) return 'fat';
    return 'mixed';
}

function getMacroBadge(type) {
    const badges = {
        'protein': '<span class="macro-badge protein-badge">PROTEIN</span>',
        'carb': '<span class="macro-badge carb-badge">CARB</span>',
        'fat': '<span class="macro-badge fat-badge">FAT</span>',
        'mixed': '<span class="macro-badge mixed-badge">MIXED</span>'
    };
    return badges[type] || '';
}

// Mode switching functions
function switchToQuickSetup() {
    isCustomMealMode = false;
    document.getElementById('quickSetupBtn').classList.add('active');
    document.getElementById('customMealsBtn').classList.remove('active');
    document.getElementById('quickSetupMode').style.display = 'block';
    document.getElementById('customMealsMode').style.display = 'none';
    updateGenerateButton();
}

function switchToCustomMeals() {
    isCustomMealMode = true;
    document.getElementById('quickSetupBtn').classList.remove('active');
    document.getElementById('customMealsBtn').classList.add('active');
    document.getElementById('quickSetupMode').style.display = 'none';
    document.getElementById('customMealsMode').style.display = 'block';
    
    // Generate meal tabs based on meal count
    generateMealTabs();
    updateGenerateButton();
}

function generateMealTabs() {
    const mealsCount = parseInt(document.getElementById('mealsCount').value) || 4;
    const mealTypes = getMealTypes(mealsCount);
    const mealDisplayNames = ['Breakfast', 'Lunch', 'Dinner', 'Snack', 'Pre-Workout', 'Post-Workout'];
    
    // Initialize meal-specific foods structure
    mealSpecificFoods = {};
    mealTypes.forEach(mealType => {
        mealSpecificFoods[mealType] = {
            protein: [],
            carb: [],
            fat: [],
            veggie: []
        };
    });
    
    // Generate tab buttons
    const tabButtons = document.getElementById('mealTabButtons');
    const tabContent = document.getElementById('mealTabContent');
    
    tabButtons.innerHTML = '';
    tabContent.innerHTML = '';
    
    mealTypes.forEach((mealType, index) => {
        const displayName = mealDisplayNames[index] || `Meal ${index + 1}`;
        
        // Create tab button
        const tabBtn = document.createElement('button');
        tabBtn.className = `tab-btn ${index === 0 ? 'active' : ''}`;
        tabBtn.onclick = () => switchMealTab(mealType, tabBtn);
        tabBtn.textContent = displayName;
        tabButtons.appendChild(tabBtn);
        
        // Create tab content
        const tabContentDiv = document.createElement('div');
        tabContentDiv.className = `meal-tab-content ${index === 0 ? 'active' : ''}`;
        tabContentDiv.id = `${mealType}Tab`;
        
        tabContentDiv.innerHTML = `
            <div class="meal-title">${displayName} Foods</div>
            <div class="meal-food-categories">
                ${generateMealCategoryHTML(mealType, 'protein', 'PROTEIN SOURCES')}
                ${generateMealCategoryHTML(mealType, 'carb', 'CARBOHYDRATE SOURCES')}
                ${generateMealCategoryHTML(mealType, 'fat', 'FAT SOURCES')}
                ${generateMealCategoryHTML(mealType, 'veggie', 'FRUITS & VEGETABLES')}
            </div>
        `;
        
        tabContent.appendChild(tabContentDiv);
    });
    
    currentMealTab = mealTypes[0];
    
    // Populate food grids for all meals
    mealTypes.forEach(mealType => {
        ['protein', 'carb', 'fat', 'veggie'].forEach(category => {
            displayMealFoods(mealType, category, foodDatabase[category]);
        });
    });
}

function getMealTypes(count) {
    switch(count) {
        case 3: return ['breakfast', 'lunch', 'dinner'];
        case 4: return ['breakfast', 'lunch', 'dinner', 'snack'];
        case 5: return ['breakfast', 'lunch', 'dinner', 'snack', 'post-workout'];
        case 6: return ['breakfast', 'lunch', 'dinner', 'snack', 'pre-workout', 'post-workout'];
        default: return ['breakfast', 'lunch', 'dinner', 'snack'];
    }
}

function generateMealCategoryHTML(mealType, category, title) {
    return `
        <div class="compact-food-category">
            <div class="compact-category-title">${title}</div>
            <div class="compact-food-grid" id="${mealType}_${category}Grid"></div>
            <div class="compact-selected-foods">
                <h5>Selected ${title}:</h5>
                <div class="selected-food-tags" id="${mealType}_selected_${category}"></div>
            </div>
        </div>
    `;
}

function switchMealTab(mealType, clickedButton) {
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    clickedButton.classList.add('active');
    
    // Update tab content
    document.querySelectorAll('.meal-tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById(`${mealType}Tab`).classList.add('active');
    
    currentMealTab = mealType;
}

function updateMealTabs() {
    if (isCustomMealMode) {
        generateMealTabs();
    }
}

// Display all foods in each category
function loadAllFoods() {
    const categories = ['protein', 'carb', 'fat', 'veggie'];
    categories.forEach(category => {
        displayFoods(category, foodDatabase[category]);
    });
}

// Display foods in grid (clean interface, smart assignment behind the scenes)
function displayFoods(category, foods) {
    const grid = document.getElementById(`${category}Grid`);
    
    const foodsHTML = foods.map(food => {
        const macroType = getFoodMacroType(food);
        const badge = getMacroBadge(macroType);
        const isSelected = selectedFoods[category].some(f => f.id === food.id);
        
        let displayName = food.name;
        if (displayName.length > 30) {
            displayName = displayName.substring(0, 30) + '...';
        }
        
        return `
            <div class="food-item ${isSelected ? 'selected' : ''}" onclick="toggleFood('${category}', ${JSON.stringify(food).replace(/"/g, '&quot;')})">
                <div class="food-name">${displayName}</div>
                <div class="food-macros ${isSelected ? 'selected' : ''}">
                    P: ${food.protein.toFixed(1)}g | C: ${food.carbs.toFixed(1)}g | F: ${food.fat.toFixed(1)}g
                </div>
                <div class="food-badges">${badge}</div>
            </div>
        `;
    }).join('');
    
    grid.innerHTML = foodsHTML;
}

// Display foods for specific meals in custom mode
function displayMealFoods(mealType, category, foods) {
    const grid = document.getElementById(`${mealType}_${category}Grid`);
    if (!grid) return;
    
    const foodsHTML = foods.map(food => {
        const macroType = getFoodMacroType(food);
        const badge = getMacroBadge(macroType);
        const isSelected = mealSpecificFoods[mealType] && mealSpecificFoods[mealType][category].some(f => f.id === food.id);
        const isAppropriate = food.meals.includes(mealType);
        
        let displayName = food.name;
        if (displayName.length > 25) {
            displayName = displayName.substring(0, 25) + '...';
        }
        
        return `
            <div class="food-item ${isSelected ? 'selected' : ''} ${isAppropriate ? '' : 'not-appropriate'}" 
                 onclick="toggleMealFood('${mealType}', '${category}', ${JSON.stringify(food).replace(/"/g, '&quot;')})"
                 title="${isAppropriate ? food.name : food.name + ' (Not typically used for ' + mealType + ')'}">
                <div class="food-name">${displayName} ${isAppropriate ? '✓' : '⚠️'}</div>
                <div class="food-macros ${isSelected ? 'selected' : ''}">
                    P: ${food.protein.toFixed(1)}g | C: ${food.carbs.toFixed(1)}g | F: ${food.fat.toFixed(1)}g
                </div>
                <div class="food-badges">${badge}</div>
            </div>
        `;
    }).join('');
    
    grid.innerHTML = foodsHTML;
    updateMealSelectedFoodsDisplay(mealType, category);
}

// Toggle food selection for specific meals
function toggleMealFood(mealType, category, food) {
    if (!mealSpecificFoods[mealType]) {
        mealSpecificFoods[mealType] = { protein: [], carb: [], fat: [], veggie: [] };
    }
    
    const existingIndex = mealSpecificFoods[mealType][category].findIndex(f => f.id === food.id);
    
    if (existingIndex >= 0) {
        mealSpecificFoods[mealType][category].splice(existingIndex, 1);
    } else {
        mealSpecificFoods[mealType][category].push(food);
    }
    
    displayMealFoods(mealType, category, foodDatabase[category]);
    updateGenerateButton();
}

// Update selected foods display for specific meals
function updateMealSelectedFoodsDisplay(mealType, category) {
    const container = document.getElementById(`${mealType}_selected_${category}`);
    if (!container) return;
    
    const foods = mealSpecificFoods[mealType] ? mealSpecificFoods[mealType][category] : [];
    
    const tagsHTML = foods.map(food => {
        let displayName = food.name;
        if (displayName.length > 20) {
            displayName = displayName.substring(0, 20) + '...';
        }
        
        return `
            <div class="selected-food-tag" onclick="removeMealFood('${mealType}', '${category}', '${food.id}')" title="Click to remove">
                ${displayName} ✕
            </div>
        `;
    }).join('');
    
    container.innerHTML = tagsHTML || '<span style="color: #666; font-size: 11px;">None selected</span>';
}

// Remove food from meal selection
function removeMealFood(mealType, category, foodId) {
    if (mealSpecificFoods[mealType]) {
        mealSpecificFoods[mealType][category] = mealSpecificFoods[mealType][category].filter(f => f.id !== foodId);
        displayMealFoods(mealType, category, foodDatabase[category]);
        updateGenerateButton();
    }
}

// Toggle food selection
function toggleFood(category, food) {
    const existingIndex = selectedFoods[category].findIndex(f => f.id === food.id);
    
    if (existingIndex >= 0) {
        selectedFoods[category].splice(existingIndex, 1);
    } else {
        selectedFoods[category].push(food);
    }
    
    updateSelectedFoodsDisplay(category);
    updateGenerateButton();
}

// Update selected foods display
function updateSelectedFoodsDisplay(category) {
    const container = document.getElementById(`selected${category.charAt(0).toUpperCase() + category.slice(1)}s`);
    
    const tagsHTML = selectedFoods[category].map(food => {
        let displayName = food.name;
        if (displayName.length > 25) {
            displayName = displayName.substring(0, 25) + '...';
        }
        
        return `
            <div class="selected-food-tag" onclick="removeFood('${category}', '${food.id}')" title="Click to remove">
                ${displayName} ✕
            </div>
        `;
    }).join('');
    
    container.innerHTML = tagsHTML || '<span style="color: #666;">None selected</span>';
}

// Remove food from selection
function removeFood(category, foodId) {
    selectedFoods[category] = selectedFoods[category].filter(f => f.id !== foodId);
    updateSelectedFoodsDisplay(category);
    updateGenerateButton();
    
    // Refresh the food grid to show updated selection
    displayFoods(category, foodDatabase[category]);
}

// Update generate button state
function updateGenerateButton() {
    const btn = document.getElementById('generateBtn');
    let hasSelections = false;
    
    if (isCustomMealMode) {
        // Check if any meal has food selections
        hasSelections = Object.values(mealSpecificFoods).some(meal => 
            Object.values(meal).some(arr => arr.length > 0)
        );
    } else {
        // Quick setup mode
        hasSelections = Object.values(selectedFoods).some(arr => arr.length > 0);
    }
    
    btn.disabled = !hasSelections;
    btn.innerHTML = hasSelections ? '🌐 Generate My Globally Optimized Meal Plan' : '⚠️ Please select some foods first';
}

// Generate meal plan with global optimization
async function generateMealPlan() {
    const btn = document.getElementById('generateBtn');
    const output = document.getElementById('mealPlanOutput');
    
    btn.disabled = true;
    btn.innerHTML = '⏳ Generating your globally optimized meal plan...';
    
    // Get targets
    const targetProtein = parseFloat(document.getElementById('targetProtein').value) || 150;
    const targetCarbs = parseFloat(document.getElementById('targetCarbs').value) || 200;
    const targetFat = parseFloat(document.getElementById('targetFat').value) || 60;
    const mealsCount = parseInt(document.getElementById('mealsCount').value) || 4;
    
    try {
        // Generate meal plan with global optimization
        const foodSelections = isCustomMealMode ? mealSpecificFoods : selectedFoods;
        const mealPlan = await buildMealPlan({
            targetProtein,
            targetCarbs,
            targetFat,
            mealsCount,
            selectedFoods: foodSelections
        });
        
        currentMealPlan = mealPlan;
        displayMealPlan(mealPlan);
        
        output.classList.add('active');
        output.scrollIntoView({ behavior: 'smooth' });
        
    } catch (error) {
        alert('Error generating meal plan. Please try again.');
        console.error(error);
    }
    
    btn.disabled = false;
    btn.innerHTML = '🌐 Generate My Globally Optimized Meal Plan';
}

// GLOBAL OPTIMIZATION: Build entire day as one system, then balance
async function buildMealPlan(params) {
    const { mealsCount, selectedFoods } = params;
    console.log(`\n🌐 GLOBAL MEAL PLAN OPTIMIZATION`);
    console.log(`Building ${mealsCount} meals as one integrated system`);
    console.log(`Daily targets: ${params.targetProtein}p ${params.targetCarbs}c ${params.targetFat}f`);
    
    const mealNames = ['Breakfast', 'Lunch', 'Dinner', 'Snack', 'Pre-Workout', 'Post-Workout'];
    
    // STEP 1: Generate initial meal structure with SMART FOOD ASSIGNMENT
    console.log(`\n=== STEP 1: SMART MEAL STRUCTURE WITH FOOD APPROPRIATENESS ===`);
    const mealPlan = [];
    
    // Define meal types based on number of meals
    const getMealTypes = (count) => {
        switch(count) {
            case 3: return ['breakfast', 'lunch', 'dinner'];
            case 4: return ['breakfast', 'lunch', 'dinner', 'snack'];
            case 5: return ['breakfast', 'lunch', 'dinner', 'snack', 'post-workout'];
            case 6: return ['breakfast', 'lunch', 'dinner', 'snack', 'pre-workout', 'post-workout'];
            default: return ['breakfast', 'lunch', 'dinner', 'snack'];
        }
    };
    
    const mealTypes = getMealTypes(mealsCount);
    const mealDisplayNames = ['Breakfast', 'Lunch', 'Dinner', 'Snack', 'Pre-Workout', 'Post-Workout'];
    
    for (let i = 0; i < mealsCount; i++) {
        const mealType = mealTypes[i];
        const meal = {
            name: mealDisplayNames[i] || `Meal ${i + 1}`,
            type: mealType,
            foods: [],
            totals: { protein: 0, carbs: 0, fat: 0, calories: 0 }
        };
        
        console.log(`Building ${meal.name} (${mealType}) with ${isCustomMealMode ? 'user-specified' : 'smart'} foods...`);
        
        // Smart food selection based on meal type
        const availableFoods = [];
        
        if (isCustomMealMode) {
            // Use user-specified foods for this meal
            const mealFoods = mealSpecificFoods[mealType] || { protein: [], carb: [], fat: [], veggie: [] };
            
            // Add selected proteins for this meal
            if (mealFoods.protein.length > 0) {
                const chosenProtein = mealFoods.protein[0]; // Use first selected protein
                availableFoods.push({
                    food: chosenProtein,
                    type: 'protein',
                    priority: 'protein'
                });
                console.log(`  Using user-selected protein: ${chosenProtein.name} for ${mealType}`);
            }
            
            // Add selected carbs for this meal  
            if (mealFoods.carb.length > 0) {
                const chosenCarb = mealFoods.carb[0]; // Use first selected carb
                availableFoods.push({
                    food: chosenCarb,
                    type: 'carb',
                    priority: 'carbs'
                });
                console.log(`  Using user-selected carb: ${chosenCarb.name} for ${mealType}`);
            }
            
            // Add selected fats for this meal
            if (mealFoods.fat.length > 0) {
                const chosenFat = mealFoods.fat[0]; // Use first selected fat
                availableFoods.push({
                    food: chosenFat,
                    type: 'fat',
                    priority: 'fat'
                });
                console.log(`  Using user-selected fat: ${chosenFat.name} for ${mealType}`);
            }
            
            // Add selected veggies for this meal
            if (mealFoods.veggie.length > 0) {
                const chosenVeggie = mealFoods.veggie[0]; // Use first selected veggie
                availableFoods.push({
                    food: chosenVeggie,
                    type: 'veggie',
                    priority: 'none'
                });
                console.log(`  Using user-selected veggie: ${chosenVeggie.name} for ${mealType}`);
            }
        } else {
            // Original smart food assignment logic
            // Smart protein selection
            if (selectedFoods.protein.length > 0) {
                const appropriateProteins = selectedFoods.protein.filter(food => 
                    food.meals.includes(mealType)
                );
                
                let chosenProtein;
                if (appropriateProteins.length > 0) {
                    // Use appropriate protein for this meal type
                    chosenProtein = appropriateProteins[i % appropriateProteins.length];
                    console.log(`  Using appropriate protein: ${chosenProtein.name} for ${mealType}`);
                } else {
                    // Fallback to any selected protein
                    chosenProtein = selectedFoods.protein[i % selectedFoods.protein.length];
                    console.log(`  Fallback protein: ${chosenProtein.name} for ${mealType}`);
                }
                
                availableFoods.push({
                    food: chosenProtein,
                    type: 'protein',
                    priority: 'protein'
                });
            }
            
            // Smart carb selection
            if (selectedFoods.carb.length > 0) {
                const appropriateCarbs = selectedFoods.carb.filter(food => 
                    food.meals.includes(mealType)
                );
                
                let chosenCarb;
                if (appropriateCarbs.length > 0) {
                    chosenCarb = appropriateCarbs[i % appropriateCarbs.length];
                    console.log(`  Using appropriate carb: ${chosenCarb.name} for ${mealType}`);
                } else {
                    chosenCarb = selectedFoods.carb[i % selectedFoods.carb.length];
                    console.log(`  Fallback carb: ${chosenCarb.name} for ${mealType}`);
                }
                
                availableFoods.push({
                    food: chosenCarb,
                    type: 'carb', 
                    priority: 'carbs'
                });
            }
            
            // Smart fat selection
            if (selectedFoods.fat.length > 0) {
                const appropriateFats = selectedFoods.fat.filter(food => 
                    food.meals.includes(mealType)
                );
                
                let chosenFat;
                if (appropriateFats.length > 0) {
                    chosenFat = appropriateFats[i % appropriateFats.length];
                    console.log(`  Using appropriate fat: ${chosenFat.name} for ${mealType}`);
                } else {
                    chosenFat = selectedFoods.fat[i % selectedFoods.fat.length];
                    console.log(`  Fallback fat: ${chosenFat.name} for ${mealType}`);
                }
                
                availableFoods.push({
                    food: chosenFat,
                    type: 'fat',
                    priority: 'fat'
                });
            }
            
            // Smart veggie selection
            if (selectedFoods.veggie.length > 0) {
                const appropriateVeggies = selectedFoods.veggie.filter(food => 
                    food.meals.includes(mealType)
                );
                
                let chosenVeggie;
                if (appropriateVeggies.length > 0) {
                    chosenVeggie = appropriateVeggies[i % appropriateVeggies.length];
                    console.log(`  Using appropriate veggie: ${chosenVeggie.name} for ${mealType}`);
                } else {
                    chosenVeggie = selectedFoods.veggie[i % selectedFoods.veggie.length];
                    console.log(`  Fallback veggie: ${chosenVeggie.name} for ${mealType}`);
                }
                
                availableFoods.push({
                    food: chosenVeggie,
                    type: 'veggie',
                    priority: 'none'
                });
            }
        }
        
        // Start with rough equal portions per meal as baseline
        const basePortionSize = 100; // grams
        availableFoods.forEach(item => {
            item.quantity = basePortionSize;
            item.nutritionMultiplier = basePortionSize / 100;
            item.explanation = 'as listed in database';
            meal.foods.push(item);
        });
        
        mealPlan.push(meal);
    }
    
    // STEP 2: Global optimization across entire day
    console.log(`\n=== STEP 2: GLOBAL SYSTEM OPTIMIZATION ===`);
    const optimizedPlan = await globalOptimizeMealPlan(mealPlan, {
        targetProtein: params.targetProtein,
        targetCarbs: params.targetCarbs,
        targetFat: params.targetFat
    });
    
    // STEP 3: Calculate final totals and verify
    console.log(`\n=== STEP 3: FINAL VERIFICATION ===`);
    optimizedPlan.forEach(meal => {
        meal.totals = { protein: 0, carbs: 0, fat: 0, calories: 0 };
        meal.foods.forEach(item => {
            if (item.quantity > 5) { // Only include meaningful quantities
                const protein = item.food.protein * item.nutritionMultiplier;
                const carbs = item.food.carbs * item.nutritionMultiplier;
                const fat = item.food.fat * item.nutritionMultiplier;
                const calories = item.food.calories * item.nutritionMultiplier;
                
                meal.totals.protein += protein;
                meal.totals.carbs += carbs;
                meal.totals.fat += fat;
                meal.totals.calories += calories;
            }
        });
        
        console.log(`${meal.name}: ${meal.totals.protein.toFixed(1)}p ${meal.totals.carbs.toFixed(1)}c ${meal.totals.fat.toFixed(1)}f ${meal.totals.calories.toFixed(0)}cal`);
    });
    
    return optimizedPlan;
}

// Simplified global optimization for demo
async function globalOptimizeMealPlan(mealPlan, targets) {
    // Basic optimization - adjust quantities to meet targets
    const iterations = 20;
    
    for (let i = 0; i < iterations; i++) {
        // Calculate current totals
        let totalProtein = 0, totalCarbs = 0, totalFat = 0;
        
        mealPlan.forEach(meal => {
            meal.foods.forEach(item => {
                totalProtein += item.food.protein * (item.quantity / 100);
                totalCarbs += item.food.carbs * (item.quantity / 100);
                totalFat += item.food.fat * (item.quantity / 100);
            });
        });
        
        // Calculate ratios
        const proteinRatio = targets.targetProtein / totalProtein;
        const carbsRatio = targets.targetCarbs / totalCarbs;
        const fatRatio = targets.targetFat / totalFat;
        
        // Adjust quantities
        mealPlan.forEach(meal => {
            meal.foods.forEach(item => {
                let adjustmentFactor = 1;
                
                if (item.priority === 'protein') {
                    adjustmentFactor = Math.min(1.2, Math.max(0.8, proteinRatio * 0.9 + 0.1));
                } else if (item.priority === 'carbs') {
                    adjustmentFactor = Math.min(1.2, Math.max(0.8, carbsRatio * 0.9 + 0.1));
                } else if (item.priority === 'fat') {
                    adjustmentFactor = Math.min(1.2, Math.max(0.8, fatRatio * 0.9 + 0.1));
                }
                
                item.quantity = Math.min(500, Math.max(10, item.quantity * adjustmentFactor));
                item.nutritionMultiplier = item.quantity / 100;
            });
        });
        
        // Check if close enough
        if (Math.abs(proteinRatio - 1) < 0.05 && Math.abs(carbsRatio - 1) < 0.05 && Math.abs(fatRatio - 1) < 0.05) {
            console.log(`Optimization converged at iteration ${i + 1}`);
            break;
        }
    }
    
    return mealPlan;
}

// Display generated meal plan
function displayMealPlan(mealPlan) {
    const container = document.getElementById('generatedMeals');
    
    const mealsHTML = mealPlan.map((meal, index) => {
        const foodsHTML = meal.foods.map(item => {
            const macroType = getFoodMacroType(item.food);
            const badge = getMacroBadge(macroType);
            
            // Use nutritionMultiplier for accurate macro calculations
            const multiplier = item.nutritionMultiplier || (item.quantity / 100);
            const itemProtein = (item.food.protein * multiplier).toFixed(1);
            const itemCarbs = (item.food.carbs * multiplier).toFixed(1);
            const itemFat = (item.food.fat * multiplier).toFixed(1);
            const itemCalories = (item.food.calories * multiplier).toFixed(0);
            
            return `
                <div class="meal-food">
                    <div class="food-details">
                        <div class="food-info">
                            <div style="font-weight: bold;">${item.food.name} ${badge}</div>
                            <div class="food-nutrition">P: ${itemProtein}g | C: ${itemCarbs}g | F: ${itemFat}g | Cal: ${itemCalories}</div>
                            <div style="font-size: 10px; color: #ffa500; font-style: italic; margin-top: 2px;">📏 ${item.explanation}</div>
                        </div>
                        <div class="food-quantity">${item.quantity.toFixed(1)}g</div>
                    </div>
                </div>
            `;
        }).join('');
        
        return `
            <div class="meal-section">
                <div class="meal-header">Meal ${index + 1}: ${meal.name} (${meal.totals.calories.toFixed(0)} calories)</div>
                ${foodsHTML}
                <div class="meal-totals">
                    <strong>Meal Totals:</strong> 
                    P: ${meal.totals.protein.toFixed(1)}g | 
                    C: ${meal.totals.carbs.toFixed(1)}g | 
                    F: ${meal.totals.fat.toFixed(1)}g | 
                    <strong>Cal: ${meal.totals.calories.toFixed(0)}</strong>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = mealsHTML;
    
    // Update daily summary
    updateDailySummary(mealPlan);
}

// Update daily summary with progress indicators
function updateDailySummary(mealPlan) {
    const dailyTotals = mealPlan.reduce((totals, meal) => ({
        protein: totals.protein + meal.totals.protein,
        carbs: totals.carbs + meal.totals.carbs,
        fat: totals.fat + meal.totals.fat,
        calories: totals.calories + meal.totals.calories
    }), { protein: 0, carbs: 0, fat: 0, calories: 0 });
    
    const targetProtein = parseFloat(document.getElementById('targetProtein').value) || 1;
    const targetCarbs = parseFloat(document.getElementById('targetCarbs').value) || 1;
    const targetFat = parseFloat(document.getElementById('targetFat').value) || 1;
    
    // Calculate accuracy percentages
    const proteinAccuracy = (dailyTotals.protein / targetProtein) * 100;
    const carbsAccuracy = (dailyTotals.carbs / targetCarbs) * 100;
    const fatAccuracy = (dailyTotals.fat / targetFat) * 100;
    
    // Update display with accuracy indicators
    const getAccuracyIcon = (accuracy) => {
        if (accuracy >= 99 && accuracy <= 101) {
            return '<span style="color: #FFD700; text-shadow: 0 0 5px #FFD700;">👑</span>';
        } else if (accuracy >= 95 && accuracy <= 105) {
            return '<span style="color: #2ecc71;">✓</span>';
        } else if (accuracy >= 90 && accuracy <= 110) {
            return '<span style="color: #f39c12;">⚡</span>';
        } else {
            return '<span style="color: #e74c3c;">⚠</span>';
        }
    };
    
    document.getElementById('totalProtein').innerHTML = 
        `${dailyTotals.protein.toFixed(1)} ${getAccuracyIcon(proteinAccuracy)}`;
    document.getElementById('totalCarbs').innerHTML = 
        `${dailyTotals.carbs.toFixed(1)} ${getAccuracyIcon(carbsAccuracy)}`;
    document.getElementById('totalFat').innerHTML = 
        `${dailyTotals.fat.toFixed(1)} ${getAccuracyIcon(fatAccuracy)}`;
    document.getElementById('totalCalories').textContent = dailyTotals.calories.toFixed(0);
    
    // Update progress bars
    const targetCalories = targetProtein * 4 + targetCarbs * 4 + targetFat * 9;
    
    document.getElementById('proteinProgress').style.width = Math.min(100, (dailyTotals.protein / targetProtein) * 100) + '%';
    document.getElementById('carbsProgress').style.width = Math.min(100, (dailyTotals.carbs / targetCarbs) * 100) + '%';
    document.getElementById('fatProgress').style.width = Math.min(100, (dailyTotals.fat / targetFat) * 100) + '%';
    document.getElementById('caloriesProgress').style.width = Math.min(100, (dailyTotals.calories / targetCalories) * 100) + '%';
}

// Download meal plan
function downloadMealPlan() {
    if (!currentMealPlan) return;
    
    const today = new Date();
    const formattedDate = today.toLocaleDateString("en-CA");
    
    const wrapper = document.createElement("div");
    wrapper.style.background = "#fff";
    wrapper.style.color = "#000";
    wrapper.style.padding = "40px";
    wrapper.style.fontFamily = "Arial, sans-serif";
    wrapper.style.maxWidth = "800px";
    wrapper.style.lineHeight = "1.6";

    const title = document.createElement("h2");
    title.innerText = `BUILT AUTOMATED MEAL PLAN – ${formattedDate}`;
    title.style.textAlign = "center";
    title.style.marginBottom = "30px";
    title.style.color = "#000";

    let content = '';
    
    // Add meal plan content
    currentMealPlan.forEach((meal, index) => {
        content += `\nMEAL ${index + 1}: ${meal.name.toUpperCase()}\n`;
        content += '─'.repeat(50) + '\n';
        
        meal.foods.forEach(item => {
            const multiplier = item.nutritionMultiplier || (item.quantity / 100);
            content += `• ${item.quantity.toFixed(1)}g ${item.food.name}\n`;
            content += `  P: ${(item.food.protein * multiplier).toFixed(1)}g | C: ${(item.food.carbs * multiplier).toFixed(1)}g | F: ${(item.food.fat * multiplier).toFixed(1)}g | Cal: ${(item.food.calories * multiplier).toFixed(0)}\n`;
        });
        
        content += `\nMeal Totals: P: ${meal.totals.protein.toFixed(1)}g | C: ${meal.totals.carbs.toFixed(1)}g | F: ${meal.totals.fat.toFixed(1)}g | Cal: ${meal.totals.calories.toFixed(0)}\n\n`;
    });
    
    // Add daily totals
    const dailyTotals = currentMealPlan.reduce((totals, meal) => ({
        protein: totals.protein + meal.totals.protein,
        carbs: totals.carbs + meal.totals.carbs,
        fat: totals.fat + meal.totals.fat,
        calories: totals.calories + meal.totals.calories
    }), { protein: 0, carbs: 0, fat: 0, calories: 0 });
    
    content += '\n' + '═'.repeat(60) + '\n';
    content += 'DAILY TOTALS:\n';
    content += `Protein: ${dailyTotals.protein.toFixed(1)}g / ${document.getElementById('targetProtein').value}g\n`;
    content += `Carbs: ${dailyTotals.carbs.toFixed(1)}g / ${document.getElementById('targetCarbs').value}g\n`;
    content += `Fat: ${dailyTotals.fat.toFixed(1)}g / ${document.getElementById('targetFat').value}g\n`;
    content += `Calories: ${dailyTotals.calories.toFixed(0)}\n\n`;
    content += '* Generated from USDA FoodData Central database\n';
    content += '* Quantities automatically calculated to meet your macro targets\n';
    content += `* Food selection mode: ${isCustomMealMode ? 'Custom Per Meal' : 'Quick Setup'}`;

    const contentEl = document.createElement("pre");
    contentEl.innerText = content;
    contentEl.style.whiteSpace = "pre-wrap";
    contentEl.style.fontSize = "11px";
    contentEl.style.color = "#000";

    wrapper.appendChild(title);
    wrapper.appendChild(contentEl);
    document.body.appendChild(wrapper);

    html2canvas(wrapper, { scale: 2 }).then(canvas => {
        const link = document.createElement("a");
        link.download = `BUILT_Meal_Plan_${formattedDate.replace(/\s/g, "_")}.png`;
        link.href = canvas.toDataURL();
        link.click();
        document.body.removeChild(wrapper);
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateGenerateButton();
    
    // Load all foods from built-in database
    loadAllFoods();
    
    console.log('✅ Loaded built-in food database with', 
        Object.values(foodDatabase).reduce((sum, cat) => sum + cat.length, 0), 'foods');
});
</script>
</body>
</html>

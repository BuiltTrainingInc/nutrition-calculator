<script>
async function swapMacros() {
  const originalFood = document.getElementById("originalFood").value;
  const replacementFood = document.getElementById("replacementFood").value;

  if (!originalFood || !replacementFood) {
    document.getElementById("replacementQty").innerText = "Please fill in both foods.";
    return;
  }

  document.getElementById("replacementQty").innerText = "Calculating equivalent...";
  document.getElementById("macroTable").style.display = "none";

  try {
    const res = await fetch("/api/api/macro-swap", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        originalFood: originalFood,
        replacementFood: replacementFood
      })
    });

    const data = await res.json();
    
    if (data.error) {
      document.getElementById("replacementQty").innerText = "Error calculating swap. Please try again.";
      return;
    }

    const reply = data.choices?.[0]?.message?.content || "Something went wrong.";

    // Extract replacement quantity
    const qtyMatch = reply.match(/Replacement Quantity: ([^\n]+)/);
    if (qtyMatch) {
      document.getElementById("replacementQty").innerText = `Replacement Quantity: ${qtyMatch[1]}`;
    } else {
      document.getElementById("replacementQty").innerText = "Replacement Quantity: Not found.";
    }

    // Extract and format table
    const tableMatch = reply.match(/\| Food \|(.|\n)*?\| Replacement \|(.|\n)*?\|/);
    if (tableMatch) {
      const lines = tableMatch[0].trim().split("\n");
      const dataRows = lines.slice(2); // Skip header and separator
      
      const tableHTML = dataRows.map(row => {
        const cols = row.split("|").slice(1, -1); // Remove first/last empty elements
        return `<tr>${cols.map(cell => `<td style='padding: 10px; border: 1px solid #333; font-weight: 500;'>${cell.trim()}</td>`).join("")}</tr>`;
      }).join("");
      
      document.getElementById("macroTableBody").innerHTML = tableHTML;
      document.getElementById("macroTable").style.display = "block";
    }
    
  } catch (error) {
    console.error('Error:', error);
    document.getElementById("replacementQty").innerText = "Error connecting to server. Please try again.";
  }
}
</script>

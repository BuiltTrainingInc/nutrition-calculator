<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BUILT Macro Swap Tool</title>
</head>
<body>
<div style="max-width: 600px; margin: auto; font-family: Arial, sans-serif; padding: 20px; background-color: #121212; color: #f0f0f0; border-radius: 10px;">
  <h2 style="text-align: center; font-size: 22px;">BUILT Macro Swap Tool</h2>
  <p style="text-align: center; margin-bottom: 20px;">Swap any food for a similar macro equivalent</p>

  <!-- Instructions Box -->
  <div style="background: #1a4a6b; padding: 15px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #4da6d9;">
    <h3 style="margin: 0 0 10px 0; color: #4da6d9; font-size: 16px;">‚ö†Ô∏è For Accurate Calculations, Be Specific:</h3>
    <ul style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.6;">
      <li><strong>Include weight/quantity:</strong> "100g chicken breast" not just "chicken"</li>
      <li><strong>Specify cooking method:</strong> "100g cooked rice" vs "100g dry rice"</li>
      <li><strong>Be precise with pasta:</strong> "100g dry weight pasta" vs "100g cooked pasta"</li>
      <li><strong>Include preparation:</strong> "1 large baked sweet potato" vs "sweet potato"</li>
      <li><strong>Specify cuts:</strong> "100g lean ground beef (93/7)" vs "ground beef"</li>
    </ul>
  </div>

  <!-- Data Source Badge -->
  <div style="background: #0f3460; padding: 12px; border-radius: 6px; margin-bottom: 20px; text-align: center; border: 1px solid #4da6d9;">
    <div style="font-size: 14px; color: #4da6d9; font-weight: bold;">üèõÔ∏è USDA FoodData Central + ü§ñ AI Powered</div>
    <div style="font-size: 12px; color: #ccc; margin-top: 4px;">Uses official USDA nutrition database with AI fallback for maximum accuracy</div>
  </div>

  <label><strong>Original Food</strong></label>
  <input id="originalFood" type="text" placeholder="e.g. 100g cooked chicken breast, 150g dry weight pasta" style="width: 100%; padding: 10px; margin-bottom: 15px; background: #1e1e1e; color: white; border: 1px solid #333; box-sizing: border-box; border-radius: 4px;">

  <label><strong>Replacement Food</strong></label>
  <input id="replacementFood" type="text" placeholder="e.g. salmon fillet, quinoa" style="width: 100%; padding: 10px; margin-bottom: 20px; background: #1e1e1e; color: white; border: 1px solid #333; box-sizing: border-box; border-radius: 4px;">

  <button onclick="swapMacros()" style="width: 100%; padding: 12px; font-size: 16px; background-color: #2e2e2e; color: white; border: none; border-radius: 6px; cursor: pointer;">Get Equivalent Quantity</button>

  <div id="replacementQty" style="margin-top: 30px; font-weight: bold; color: #f0f0f0;"></div>

  <div id="macroTable" style="margin-top: 20px; display: none;">
    <h3 style="border-bottom: 1px solid #444; padding-bottom: 5px;">Macro Comparison</h3>
    <table style="width: 100%; border-collapse: collapse; background: #181818;">
      <thead>
        <tr style="background-color: #222;">
          <th style="padding: 12px; border: 1px solid #333; text-align: left; font-weight: bold; color: #f0f0f0;">Food</th>
          <th style="padding: 12px; border: 1px solid #333; text-align: left; font-weight: bold; color: #f0f0f0;">Quantity</th>
          <th style="padding: 12px; border: 1px solid #333; text-align: left; font-weight: bold; color: #f0f0f0;">Protein (g)</th>
          <th style="padding: 12px; border: 1px solid #333; text-align: left; font-weight: bold; color: #f0f0f0;">Carbs (g)</th>
          <th style="padding: 12px; border: 1px solid #333; text-align: left; font-weight: bold; color: #f0f0f0;">Fat (g)</th>
          <th style="padding: 12px; border: 1px solid #333; text-align: left; font-weight: bold; color: #f0f0f0;">Calories</th>
        </tr>
      </thead>
      <tbody id="macroTableBody"></tbody>
    </table>
  </div>

  <div style="margin-top: 30px;">
    <h3 style="border-bottom: 1px solid #444; padding-bottom: 5px;">Example Inputs for Best Results</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; font-size: 14px;">
      <div>
        <h4 style="color: #4da6d9; margin: 0 0 8px 0;">‚úÖ Good Examples:</h4>
        <ul style="margin: 0; padding-left: 15px; line-height: 1.6;">
          <li>100g cooked chicken breast</li>
          <li>150g dry weight brown rice</li>
          <li>1 medium baked sweet potato</li>
          <li>100g lean ground turkey (93/7)</li>
          <li>200g cooked quinoa</li>
          <li>30g raw almonds</li>
        </ul>
      </div>
      <div>
        <h4 style="color: #e74c3c; margin: 0 0 8px 0;">‚ùå Avoid These:</h4>
        <ul style="margin: 0; padding-left: 15px; line-height: 1.6;">
          <li>chicken (no weight/prep)</li>
          <li>rice (cooked vs dry?)</li>
          <li>ground beef (fat %?)</li>
          <li>pasta (dry vs cooked?)</li>
          <li>fish (what type/size?)</li>
          <li>nuts (roasted vs raw?)</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
async function swapMacros() {
  const originalFood = document.getElementById("originalFood").value;
  const replacementFood = document.getElementById("replacementFood").value;

  if (!originalFood || !replacementFood) {
    document.getElementById("replacementQty").innerText = "Please fill in both foods with specific details (weight, cooking method, etc.)";
    return;
  }

  document.getElementById("replacementQty").innerText = "üîç Searching USDA food database...";
  document.getElementById("macroTable").style.display = "none";

  try {
    // Try USDA database first for both foods
    const [originalResult, replacementResult] = await Promise.all([
      fetch("/api/usda-food-search", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ foodQuery: extractFoodName(originalFood) })
      }).then(r => r.json()),
      
      fetch("/api/usda-food-search", {
        method: "POST", 
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ foodQuery: extractFoodName(replacementFood) })
      }).then(r => r.json())
    ]);

    if (originalResult.success && replacementResult.success) {
      // Both foods found in USDA - use precise data
      calculateWithUSDAData(originalResult.food, replacementResult.food, originalFood, replacementFood);
    } else {
      // Fall back to OpenAI if either food not found in USDA
      document.getElementById("replacementQty").innerText = "ü§ñ Using AI for calculation...";
      await useOpenAICalculation(originalFood, replacementFood);
    }
    
  } catch (error) {
    console.error('Error:', error);
    // Fall back to OpenAI on any error
    await useOpenAICalculation(originalFood, replacementFood);
  }
}

function extractFoodName(input) {
  // Remove quantities and common descriptors to get base food name
  return input
    .replace(/\d+\.?\d*\s*(g|grams?|oz|ounces?|cups?|tbsp|tablespoons?|lbs?|pounds?)/gi, '')
    .replace(/\b(raw|cooked|baked|grilled|fried|steamed|boiled|roasted)\b/gi, '')
    .replace(/\b(lean|extra lean|93\/7|90\/10|85\/15|80\/20)\b/gi, '')
    .replace(/\b(dry weight|wet weight)\b/gi, '')
    .trim();
}

function parseQuantity(input) {
  const match = input.match(/(\d+(?:\.\d+)?)\s*(g|grams?|oz|ounces?|cups?|tbsp|lbs?)/i);
  if (!match) return 100; // default 100g
  
  let qty = parseFloat(match[1]);
  const unit = match[2].toLowerCase();
  
  // Convert to grams
  if (unit.includes('oz')) qty *= 28.35;
  if (unit.includes('lb')) qty *= 453.59;
  if (unit.includes('cup')) qty *= 240; // approximate for most foods
  if (unit.includes('tbsp')) qty *= 15;
  
  return qty;
}

function calculateWithUSDAData(originalFood, replacementFood, originalInput, replacementInput) {
  const originalQty = parseQuantity(originalInput);
  
  // Calculate original macros based on input quantity
  const originalMacros = {
    protein: (originalFood.protein * originalQty) / 100,
    carbs: (originalFood.carbs * originalQty) / 100,
    fat: (originalFood.fat * originalQty) / 100,
    calories: (originalFood.calories * originalQty) / 100
  };
  
  // Calculate equivalent quantity based on protein matching
  const equivalentQty = originalMacros.protein > 0 ? 
    (originalMacros.protein / replacementFood.protein) * 100 : 100;
  
  // Calculate replacement macros
  const replacementMacros = {
    protein: (replacementFood.protein * equivalentQty) / 100,
    carbs: (replacementFood.carbs * equivalentQty) / 100,
    fat: (replacementFood.fat * equivalentQty) / 100,
    calories: (replacementFood.calories * equivalentQty) / 100
  };
  
  // Display results with USDA badge
  document.getElementById("replacementQty").innerHTML = 
    `<strong>Replacement Quantity:</strong> ${equivalentQty.toFixed(0)}g of ${replacementFood.name}<br>
    <small style="color: #4da6d9; font-weight: bold;">‚úÖ Precise USDA FoodData Central</small>`;
  
  // Create comparison table
  const tableHTML = `
    <tr>
      <td style='padding: 10px; border: 1px solid #333;'>${originalFood.name}</td>
      <td style='padding: 10px; border: 1px solid #333;'>${originalQty.toFixed(0)}g</td>
      <td style='padding: 10px; border: 1px solid #333;'>${originalMacros.protein.toFixed(1)}g</td>
      <td style='padding: 10px; border: 1px solid #333;'>${originalMacros.carbs.toFixed(1)}g</td>
      <td style='padding: 10px; border: 1px solid #333;'>${originalMacros.fat.toFixed(1)}g</td>
      <td style='padding: 10px; border: 1px solid #333;'>${originalMacros.calories.toFixed(0)}</td>
    </tr>
    <tr>
      <td style='padding: 10px; border: 1px solid #333;'>${replacementFood.name}</td>
      <td style='padding: 10px; border: 1px solid #333;'>${equivalentQty.toFixed(0)}g</td>
      <td style='padding: 10px; border: 1px solid #333;'>${replacementMacros.protein.toFixed(1)}g</td>
      <td style='padding: 10px; border: 1px solid #333;'>${replacementMacros.carbs.toFixed(1)}g</td>
      <td style='padding: 10px; border: 1px solid #333;'>${replacementMacros.fat.toFixed(1)}g</td>
      <td style='padding: 10px; border: 1px solid #333;'>${replacementMacros.calories.toFixed(0)}</td>
    </tr>
  `;
  
  document.getElementById("macroTableBody").innerHTML = tableHTML;
  document.getElementById("macroTable").style.display = "block";
}

async function useOpenAICalculation(originalFood, replacementFood) {
  try {
    const res = await fetch("/api/api/macro-swap", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ originalFood, replacementFood })
    });

    const data = await res.json();
    
    if (data.error) {
      document.getElementById("replacementQty").innerText = "Error calculating swap. Try being more specific with quantities and cooking methods.";
      return;
    }

    const reply = data.choices?.[0]?.message?.content || "Something went wrong.";

    const qtyMatch = reply.match(/Replacement Quantity: ([^\n]+)/);
    if (qtyMatch) {
      document.getElementById("replacementQty").innerHTML = 
        `<strong>Replacement Quantity:</strong> ${qtyMatch[1]}<br>
        <small style="color: #ffa500; font-weight: bold;">ü§ñ AI-Powered Calculation</small>`;
    } else {
      document.getElementById("replacementQty").innerText = "Replacement Quantity: Not found. Try being more specific.";
    }

    const tableMatch = reply.match(/\| Food \|(.|\n)*?\| Replacement \|(.|\n)*?\|/);
    if (tableMatch) {
      const lines = tableMatch[0].trim().split("\n");
      const dataRows = lines.slice(2);
      
      const tableHTML = dataRows.map(row => {
        const cols = row.split("|").slice(1, -1);
        return `<tr>${cols.map(cell => `<td style='padding: 10px; border: 1px solid #333;'>${cell.trim()}</td>`).join("")}</tr>`;
      }).join("");
      
      document.getElementById("macroTableBody").innerHTML = tableHTML;
      document.getElementById("macroTable").style.display = "block";
    }
    
  } catch (error) {
    console.error('OpenAI Error:', error);
    document.getElementById("replacementQty").innerText = "Error connecting to server. Please try again.";
  }
}
</script>
</body>
</html>

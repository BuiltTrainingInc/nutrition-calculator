<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BUILT Macro Swap Tool</title>
    <style>
        .food-search-container {
            position: relative;
            margin-bottom: 15px;
        }
        
        .food-input {
            width: 100%;
            padding: 10px;
            background: #1e1e1e;
            color: white;
            border: 1px solid #333;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        
        .food-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #2a2a2a;
            border: 1px solid #333;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .food-option {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            font-size: 13px;
        }
        
        .food-option:hover {
            background: #3a3a3a;
        }
        
        .food-option:last-child {
            border-bottom: none;
        }
        
        .food-name {
            font-weight: bold;
            color: #f0f0f0;
            margin-bottom: 3px;
        }
        
        .food-macros {
            font-size: 11px;
            color: #ccc;
            margin-bottom: 2px;
        }
        
        .food-type {
            font-size: 10px;
            color: #4da6d9;
            font-weight: bold;
        }
        
        .food-brand {
            font-size: 10px;
            color: #ffa500;
            font-style: italic;
        }
        
        .quantity-input {
            width: 80px;
            padding: 8px;
            background: #1e1e1e;
            color: white;
            border: 1px solid #333;
            border-radius: 4px;
            margin-right: 8px;
            text-align: center;
        }
        
        .input-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .input-row label {
            min-width: 60px;
            margin-right: 10px;
        }
        
        .search-info {
            padding: 8px;
            background: #1a1a1a;
            color: #ccc;
            font-size: 11px;
            text-align: center;
            border-bottom: 1px solid #333;
        }
        
        .load-more {
            padding: 8px;
            background: #0f3460;
            color: #4da6d9;
            text-align: center;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }
        
        .load-more:hover {
            background: #1a4a6b;
        }
    </style>
</head>
<body>
<div style="max-width: 600px; margin: auto; font-family: Arial, sans-serif; padding: 20px; background-color: #121212; color: #f0f0f0; border-radius: 10px;">
  <h2 style="text-align: center; font-size: 22px;">BUILT Macro Swap Tool</h2>
  <p style="text-align: center; margin-bottom: 20px;">Complete USDA Food Database Access</p>

  <!-- USDA Badge -->
  <div style="background: #0f3460; padding: 12px; border-radius: 6px; margin-bottom: 20px; text-align: center; border: 1px solid #4da6d9;">
    <div style="font-size: 14px; color: #4da6d9; font-weight: bold;">üèõÔ∏è Full USDA FoodData Central</div>
    <div style="font-size: 12px; color: #ccc; margin-top: 4px;">400,000+ foods including Foundation, Legacy, Survey, and Branded foods</div>
  </div>

  <!-- Original Food Selection -->
  <div class="input-row">
    <label><strong>Quantity:</strong></label>
    <input type="number" id="originalQty" class="quantity-input" value="100" min="1">
    <span style="margin-right: 10px;">grams of</span>
  </div>
  
  <label><strong>Original Food</strong></label>
  <div class="food-search-container">
    <input type="text" id="originalFoodInput" class="food-input" placeholder="Search any food... (e.g. chicken breast, cheerios, mcdonald's)" oninput="searchFood('original')" onfocus="searchFood('original')">
    <div id="originalDropdown" class="food-dropdown"></div>
  </div>

  <!-- Replacement Food Selection -->
  <label><strong>Replacement Food</strong></label>
  <div class="food-search-container">
    <input type="text" id="replacementFoodInput" class="food-input" placeholder="Search replacement food... (any brand, preparation, or generic food)" oninput="searchFood('replacement')" onfocus="searchFood('replacement')">
    <div id="replacementDropdown" class="food-dropdown"></div>
  </div>

  <button onclick="swapMacros()" style="width: 100%; padding: 12px; font-size: 16px; background-color: #2e2e2e; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px;">Calculate Macro Swap</button>

  <div id="replacementQty" style="margin-top: 30px; font-weight: bold; color: #f0f0f0;"></div>

  <div id="macroTable" style="margin-top: 20px; display: none;">
    <h3 style="border-bottom: 1px solid #444; padding-bottom: 5px;">Macro Comparison</h3>
    <table style="width: 100%; border-collapse: collapse; background: #181818;">
      <thead>
        <tr style="background-color: #222;">
          <th style="padding: 12px; border: 1px solid #333; text-align: left; font-weight: bold; color: #f0f0f0;">Food</th>
          <th style="padding: 12px; border: 1px solid #333; text-align: left; font-weight: bold; color: #f0f0f0;">Quantity</th>
          <th style="padding: 12px; border: 1px solid #333; text-align: left; font-weight: bold; color: #f0f0f0;">Protein (g)</th>
          <th style="padding: 12px; border: 1px solid #333; text-align: left; font-weight: bold; color: #f0f0f0;">Carbs (g)</th>
          <th style="padding: 12px; border: 1px solid #333; text-align: left; font-weight: bold; color: #f0f0f0;">Fat (g)</th>
          <th style="padding: 12px; border: 1px solid #333; text-align: left; font-weight: bold; color: #f0f0f0;">Calories</th>
        </tr>
      </thead>
      <tbody id="macroTableBody"></tbody>
    </table>
  </div>

  <div style="margin-top: 30px;">
    <h3 style="border-bottom: 1px solid #444; padding-bottom: 5px;">Database Coverage</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; font-size: 14px;">
      <div>
        <h4 style="color: #4da6d9; margin: 0 0 8px 0;">ü•ó Food Types:</h4>
        <ul style="margin: 0; padding-left: 15px; line-height: 1.6;">
          <li>Raw ingredients</li>
          <li>Cooked foods</li>
          <li>Restaurant items</li>
          <li>Branded products</li>
          <li>Prepared meals</li>
        </ul>
      </div>
      <div>
        <h4 style="color: #4da6d9; margin: 0 0 8px 0;">üè™ Brands:</h4>
        <ul style="margin: 0; padding-left: 15px; line-height: 1.6;">
          <li>McDonald's, KFC, etc.</li>
          <li>Kellogg's, General Mills</li>
          <li>Pepsi, Coca-Cola</li>
          <li>And thousands more</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
let selectedFoods = {
  original: null,
  replacement: null
};

let searchTimeout;
let currentSearches = {
  original: { page: 1, hasMore: true, totalHits: 0 },
  replacement: { page: 1, hasMore: true, totalHits: 0 }
};

async function searchFood(type, loadMore = false) {
  const input = document.getElementById(`${type}FoodInput`);
  const dropdown = document.getElementById(`${type}Dropdown`);
  const searchTerm = input.value.trim();

  if (searchTerm.length < 2) {
    dropdown.style.display = 'none';
    return;
  }

  if (!loadMore) {
    currentSearches[type] = { page: 1, hasMore: true, totalHits: 0 };
  }

  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(async () => {
    try {
      const response = await fetch('/api/usda-search-dropdown', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          searchTerm,
          pageNumber: currentSearches[type].page
        })
      });

      const data = await response.json();
      
      if (data.foods && data.foods.length > 0) {
        currentSearches[type].totalHits = data.totalHits;
        currentSearches[type].hasMore = currentSearches[type].page < data.totalPages;
        
        displayFoodOptions(type, data.foods, loadMore, data.totalHits);
      } else {
        dropdown.innerHTML = '<div class="food-option" style="color: #ccc;">No foods found. Try different keywords.</div>';
        dropdown.style.display = 'block';
      }
    } catch (error) {
      console.error('Search error:', error);
      dropdown.innerHTML = '<div class="food-option" style="color: #e74c3c;">Error searching foods. Please try again.</div>';
      dropdown.style.display = 'block';
    }
  }, 300);
}

function displayFoodOptions(type, foods, append = false, totalHits = 0) {
  const dropdown = document.getElementById(`${type}Dropdown`);
  
  const foodsHTML = foods.map(food => {
    let displayName = food.name;
    if (displayName.length > 60) {
      displayName = displayName.substring(0, 60) + '...';
    }
    
    return `
      <div class="food-option" onclick="selectFood('${type}', ${JSON.stringify(food).replace(/"/g, '&quot;')})">
        <div class="food-name">${displayName}</div>
        <div class="food-macros">
          P: ${food.protein.toFixed(1)}g | C: ${food.carbs.toFixed(1)}g | F: ${food.fat.toFixed(1)}g | Cal: ${food.calories.toFixed(0)}
        </div>
        <div class="food-type">${food.dataType}${food.brandOwner ? ` | ${food.brandOwner}` : ''}</div>
      </div>
    `;
  }).join('');
  
  let content = '';
  
  if (!append) {
    content += `<div class="search-info">Found ${totalHits.toLocaleString()} foods. Showing best matches first.</div>`;
  }
  
  content += foodsHTML;
  
  if (currentSearches[type].hasMore) {
    content += `<div class="load-more" onclick="loadMoreResults('${type}')">Load More Results...</div>`;
  }
  
  if (append) {
    // Remove old "Load More" button and append new results
    const existingLoadMore = dropdown.querySelector('.load-more');
    if (existingLoadMore) {
      existingLoadMore.remove();
    }
    dropdown.innerHTML += content;
  } else {
    dropdown.innerHTML = content;
  }
  
  dropdown.style.display = 'block';
}

function loadMoreResults(type) {
  currentSearches[type].page++;
  searchFood(type, true);
}

function selectFood(type, food) {
  selectedFoods[type] = food;
  document.getElementById(`${type}FoodInput`).value = food.name;
  document.getElementById(`${type}Dropdown`).style.display = 'none';
}

// Hide dropdowns when clicking outside
document.addEventListener('click', function(e) {
  if (!e.target.closest('.food-search-container')) {
    document.querySelectorAll('.food-dropdown').forEach(dropdown => {
      dropdown.style.display = 'none';
    });
  }
});

async function swapMacros() {
  const originalQty = parseFloat(document.getElementById('originalQty').value) || 100;
  
  if (!selectedFoods.original || !selectedFoods.replacement) {
    document.getElementById("replacementQty").innerText = "Please select both foods from the dropdown options.";
    return;
  }

  document.getElementById("replacementQty").innerText = "üîç Calculating macro swap...";
  document.getElementById("macroTable").style.display = "none";

  const originalFood = selectedFoods.original;
  const replacementFood = selectedFoods.replacement;

  // Calculate original macros based on input quantity
  const originalMacros = {
    protein: (originalFood.protein * originalQty) / 100,
    carbs: (originalFood.carbs * originalQty) / 100,
    fat: (originalFood.fat * originalQty) / 100,
    calories: (originalFood.calories * originalQty) / 100
  };
  
  // Calculate equivalent quantity based on protein matching
  const equivalentQty = originalMacros.protein > 0 ? 
    (originalMacros.protein / replacementFood.protein) * 100 : 100;
  
  // Calculate replacement macros
  const replacementMacros = {
    protein: (replacementFood.protein * equivalentQty) / 100,
    carbs: (replacementFood.carbs * equivalentQty) / 100,
    fat: (replacementFood.fat * equivalentQty) / 100,
    calories: (replacementFood.calories * equivalentQty) / 100
  };
  
  // Display results
  document.getElementById("replacementQty").innerHTML = 
    `<strong>Replacement Quantity:</strong> ${equivalentQty.toFixed(0)}g of ${replacementFood.name}<br>
    <small style="color: #4da6d9; font-weight: bold;">‚úÖ USDA FoodData Central (ID: ${replacementFood.id})</small>`;
  
  // Create comparison table
  const tableHTML = `
    <tr>
      <td style='padding: 10px; border: 1px solid #333;'>${originalFood.name}</td>
      <td style='padding: 10px; border: 1px solid #333;'>${originalQty.toFixed(0)}g</td>
      <td style='padding: 10px; border: 1px solid #333;'>${originalMacros.protein.toFixed(1)}g</td>
      <td style='padding: 10px; border: 1px solid #333;'>${originalMacros.carbs.toFixed(1)}g</td>
      <td style='padding: 10px; border: 1px solid #333;'>${originalMacros.fat.toFixed(1)}g</td>
      <td style='padding: 10px; border: 1px solid #333;'>${originalMacros.calories.toFixed(0)}</td>
    </tr>
    <tr>
      <td style='padding: 10px; border: 1px solid #333;'>${replacementFood.name}</td>
      <td style='padding: 10px; border: 1px solid #333;'>${equivalentQty.toFixed(0)}g</td>
      <td style='padding: 10px; border: 1px solid #333;'>${replacementMacros.protein.toFixed(1)}g</td>
      <td style='padding: 10px; border: 1px solid #333;'>${replacementMacros.carbs.toFixed(1)}g</td>
      <td style='padding: 10px; border: 1px solid #333;'>${replacementMacros.fat.toFixed(1)}g</td>
      <td style='padding: 10px; border: 1px solid #333;'>${replacementMacros.calories.toFixed(0)}</td>
    </tr>
  `;
  
  document.getElementById("macroTableBody").innerHTML = tableHTML;
  document.getElementById("macroTable").style.display = "block";
}
</script>
</body>
</html>
